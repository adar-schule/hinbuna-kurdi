<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <!-- Generated by Claude Code · Hinbûna Kurdî · S6 Lesson Player · Activity-based learning -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tu çawa yî? — Lesson — Hinbûna Kurdî</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='none'/%3E%3Cpolygon points='50.0,5.0 53.0,30.2 63.3,7.0 58.7,32.0 75.3,12.8 63.6,35.3 85.2,21.9 67.3,40.0 91.9,33.6 69.5,45.6 94.9,46.6 69.9,51.5 93.9,60.0 68.6,57.3 89.0,72.5 65.6,62.5 80.6,83.0 61.3,66.5 69.5,90.5 55.9,69.1 56.7,94.5 50.0,70.0 43.3,94.5 44.1,69.1 30.5,90.5 38.7,66.5 19.4,83.0 34.4,62.5 11.0,72.5 31.4,57.3 6.1,60.0 30.1,51.5 5.1,46.6 30.5,45.6 8.1,33.6 32.7,40.0 14.8,21.9 36.4,35.3 24.7,12.8 41.3,32.0 36.7,7.0 47.0,30.2' fill='%23D4A843'/%3E%3Ccircle cx='50' cy='50' r='16' fill='%23D4A843'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
  <script src="shared/theme.js"></script>
  <style>
    /* ============================================
       DESIGN TOKENS
       ============================================ */
    :root {
      --bg-page: #FDF8F3; --bg-surface: #F5EEE6; --color-primary: #2D5A3D;
      --color-primary-hover: #24493A; --color-accent: #D4A843; --color-accent-hover: #c99b3a;
      --color-tan: #E3C79D; --text-primary: #1A2A1F; --text-secondary: #5A6B5E;
      --border: #E5DDD3; --color-success: #2D8A4E; --color-error: #DC4545;
      --color-warning: #EFB034; --color-info: #3B7A8A;
      --shadow-sm: 0 1px 3px rgba(26,42,31,0.06); --shadow-md: 0 4px 12px rgba(26,42,31,0.08);
      --shadow-lg: 0 8px 24px rgba(26,42,31,0.10);
      --font-heading: 'Nunito', sans-serif; --font-body: 'Inter', sans-serif;
      --radius-xs: 4px; --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
      --stripe-height: 2px;
    }
    [data-theme="dark"] {
      --bg-page: #1A2F23; --bg-surface: #243D30; --color-primary: #2D5A3D;
      --color-primary-hover: #367248; --color-accent: #D4A843; --color-accent-hover: #e0b64e;
      --color-tan: #3A5E45; --text-primary: #F5EEE6; --text-secondary: #A8B5AC;
      --border: #2F4F3A; --color-success: #3DA863; --color-error: #E05555;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.2); --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.3);
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-body); font-size: 15px; line-height: 1.6; color: var(--text-primary); background-color: var(--bg-page); min-height: 100dvh; display: flex; flex-direction: column; overflow-x: hidden; }
    body, .player-header, .activity-card, .feedback-drawer { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }

    /* ============================================
       PLAYER HEADER — progress bar + close
       ============================================ */
    .player-header { position: sticky; top: 0; z-index: 100; background-color: var(--bg-page); padding: 12px 20px 0; }
    .player-header-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .close-btn { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border: none; background: none; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); transition: background-color 0.2s, color 0.2s; flex-shrink: 0; }
    .close-btn:hover { background-color: var(--bg-surface); color: var(--text-primary); }
    .close-btn svg { width: 22px; height: 22px; }
    .progress-wrap { flex: 1; display: flex; align-items: center; gap: 10px; }
    .progress-bar { flex: 1; height: 8px; background-color: var(--bg-surface); border-radius: 4px; overflow: hidden; border: 1px solid var(--border); }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-accent)); border-radius: 4px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); width: 0%; }
    .progress-text { font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap; min-width: 32px; text-align: right; }

    /* ============================================
       MAIN CONTENT AREA
       ============================================ */
    .player-main { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 24px 20px 120px; max-width: 600px; margin: 0 auto; width: 100%; }

    /* Activity type badge */
    .activity-type-badge { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; padding: 4px 12px; border-radius: 20px; background-color: var(--bg-surface); border: 1px solid var(--border); color: var(--text-secondary); margin-bottom: 16px; }

    /* Activity instruction */
    .activity-instruction { font-family: var(--font-heading); font-weight: 700; font-size: 20px; color: var(--text-primary); text-align: center; margin-bottom: 28px; line-height: 1.3; }

    /* ============================================
       FLASHCARD
       ============================================ */
    .flashcard-container { perspective: 800px; width: 100%; max-width: 320px; margin: 0 auto 24px; }
    .flashcard { width: 100%; height: 220px; cursor: pointer; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); border-radius: var(--radius-xl); }
    .flashcard.flipped { transform: rotateY(180deg); }
    .flashcard-face { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; backface-visibility: hidden; border-radius: var(--radius-xl); border: 2px solid var(--border); padding: 24px; text-align: center; }
    .flashcard-front { background-color: var(--bg-surface); }
    .flashcard-back { background: linear-gradient(135deg, var(--color-primary), #3A7A50); color: #FDF8F3; transform: rotateY(180deg); border-color: transparent; }
    [data-theme="dark"] .flashcard-back { background: linear-gradient(135deg, var(--color-accent), #C49530); color: #1A2A1F; }
    .flashcard-word { font-family: var(--font-heading); font-weight: 800; font-size: 32px; line-height: 1.2; margin-bottom: 8px; }
    .flashcard-hint { font-size: 13px; opacity: 0.7; }
    .flashcard-translation { font-family: var(--font-heading); font-weight: 800; font-size: 28px; line-height: 1.2; margin-bottom: 6px; }
    .flashcard-example { font-size: 14px; opacity: 0.85; font-style: italic; }
    .flashcard-tap-hint { font-size: 12px; color: var(--text-secondary); margin-top: 8px; }

    /* ============================================
       LISTEN BUTTON — inline audio icon
       ============================================ */
    .listen-btn { display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border: none; background: none; border-radius: 50%; cursor: pointer; color: var(--color-primary); transition: background-color 0.2s, color 0.2s, transform 0.15s; flex-shrink: 0; padding: 0; vertical-align: middle; }
    [data-theme="dark"] .listen-btn { color: var(--color-accent); }
    .listen-btn:hover { background-color: rgba(45,90,61,0.10); transform: scale(1.1); }
    [data-theme="dark"] .listen-btn:hover { background-color: rgba(212,168,67,0.12); }
    .listen-btn:active { transform: scale(0.95); }
    .listen-btn svg { width: 18px; height: 18px; }
    .listen-btn.playing { animation: pulse-listen 0.8s ease infinite; }
    @keyframes pulse-listen { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    /* Variants for different contexts */
    .listen-btn.listen-sm { width: 24px; height: 24px; }
    .listen-btn.listen-sm svg { width: 14px; height: 14px; }
    .listen-btn.listen-light { color: rgba(253,248,243,0.8); }
    .listen-btn.listen-light:hover { color: #FDF8F3; background-color: rgba(253,248,243,0.15); }
    [data-theme="dark"] .listen-btn.listen-light { color: rgba(26,42,31,0.7); }
    [data-theme="dark"] .listen-btn.listen-light:hover { color: #1A2A1F; background-color: rgba(26,42,31,0.15); }
    /* Flashcard word row with listen */
    .flashcard-word-row { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 8px; }
    .flashcard-translation-row { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 6px; }
    /* Dialogue line with inline listen */
    .dialogue-ku-row { display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
    .dialogue-ku-row .dialogue-ku { margin-bottom: 0; }
    /* Gap-fill sentence row */
    .gapfill-row { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 28px; }
    .gapfill-row .gapfill-sentence { margin-bottom: 0; }
    /* Match item with listen */
    .match-item-inner { display: flex; align-items: center; justify-content: center; gap: 4px; }

    /* ============================================
       READING / DIALOGUE
       ============================================ */
    .dialogue-card { width: 100%; background-color: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px 20px; margin-bottom: 20px; }
    .dialogue-title { font-family: var(--font-heading); font-weight: 700; font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px; }
    .dialogue-line { display: flex; gap: 10px; margin-bottom: 14px; align-items: flex-start; }
    .dialogue-line:last-child { margin-bottom: 0; }
    .dialogue-speaker { font-weight: 700; font-size: 13px; color: var(--color-primary); min-width: 52px; padding-top: 2px; }
    [data-theme="dark"] .dialogue-speaker { color: var(--color-accent); }
    .dialogue-bubble { background-color: var(--bg-page); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px 14px; flex: 1; }
    .dialogue-ku { font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 2px; }
    .dialogue-en { font-size: 13px; color: var(--text-secondary); font-style: italic; }
    .dialogue-audio-btn { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; color: var(--color-primary); background: none; border: 1px solid var(--border); border-radius: 20px; padding: 6px 14px; cursor: pointer; margin-top: 12px; transition: background-color 0.2s, border-color 0.2s; }
    [data-theme="dark"] .dialogue-audio-btn { color: var(--color-accent); }
    .dialogue-audio-btn:hover { background-color: var(--bg-page); border-color: var(--color-primary); }
    [data-theme="dark"] .dialogue-audio-btn:hover { border-color: var(--color-accent); }
    .dialogue-audio-btn svg { width: 16px; height: 16px; }

    /* ============================================
       MCQ OPTIONS
       ============================================ */
    .mcq-options { width: 100%; display: flex; flex-direction: column; gap: 10px; }
    .mcq-option { display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius-md); background-color: var(--bg-surface); cursor: pointer; font-family: var(--font-body); font-size: 15px; font-weight: 500; color: var(--text-primary); transition: border-color 0.2s, background-color 0.2s, transform 0.15s; text-align: left; }
    .mcq-option:hover { border-color: var(--color-primary); transform: translateY(-1px); }
    [data-theme="dark"] .mcq-option:hover { border-color: var(--color-accent); }
    .mcq-option.selected { border-color: var(--color-primary); background-color: rgba(45,90,61,0.08); }
    [data-theme="dark"] .mcq-option.selected { border-color: var(--color-accent); background-color: rgba(212,168,67,0.12); }
    .mcq-option.correct { border-color: var(--color-success); background-color: rgba(45,138,78,0.10); }
    .mcq-option.wrong { border-color: var(--color-error); background-color: rgba(220,69,69,0.08); animation: shake 0.4s ease; }
    .mcq-letter { width: 28px; height: 28px; border-radius: 50%; background-color: var(--bg-page); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: var(--text-secondary); flex-shrink: 0; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
    .mcq-option.selected .mcq-letter { background-color: var(--color-primary); color: #FDF8F3; border-color: var(--color-primary); }
    [data-theme="dark"] .mcq-option.selected .mcq-letter { background-color: var(--color-accent); color: #1A2A1F; border-color: var(--color-accent); }
    .mcq-option.correct .mcq-letter { background-color: var(--color-success); color: #FDF8F3; border-color: var(--color-success); }
    .mcq-option.wrong .mcq-letter { background-color: var(--color-error); color: #FDF8F3; border-color: var(--color-error); }

    /* ============================================
       GAP FILL
       ============================================ */
    .gapfill-sentence { font-family: var(--font-heading); font-weight: 700; font-size: 24px; text-align: center; margin-bottom: 28px; line-height: 1.5; color: var(--text-primary); }
    .gap-slot { display: inline-block; min-width: 80px; border-bottom: 3px solid var(--color-primary); padding: 2px 8px; margin: 0 4px; text-align: center; color: var(--color-primary); font-weight: 700; }
    [data-theme="dark"] .gap-slot { border-color: var(--color-accent); color: var(--color-accent); }
    .gap-slot.filled { border-color: var(--color-success); color: var(--color-success); }
    .gap-slot.wrong { border-color: var(--color-error); color: var(--color-error); }
    .word-bank { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .word-chip { padding: 8px 18px; border: 2px solid var(--border); border-radius: 20px; background-color: var(--bg-surface); font-size: 15px; font-weight: 600; color: var(--text-primary); cursor: pointer; transition: border-color 0.2s, background-color 0.2s, transform 0.15s, opacity 0.3s; }
    .word-chip:hover { border-color: var(--color-primary); transform: translateY(-2px); }
    [data-theme="dark"] .word-chip:hover { border-color: var(--color-accent); }
    .word-chip.used { opacity: 0.35; pointer-events: none; }

    /* ============================================
       MATCHING
       ============================================ */
    .matching-container { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .match-item { padding: 14px 12px; border: 2px solid var(--border); border-radius: var(--radius-md); background-color: var(--bg-surface); text-align: center; font-size: 15px; font-weight: 600; cursor: pointer; transition: border-color 0.2s, background-color 0.2s, transform 0.15s; color: var(--text-primary); }
    .match-item:hover { border-color: var(--color-primary); transform: translateY(-1px); }
    [data-theme="dark"] .match-item:hover { border-color: var(--color-accent); }
    .match-item.selected { border-color: var(--color-primary); background-color: rgba(45,90,61,0.08); }
    [data-theme="dark"] .match-item.selected { border-color: var(--color-accent); background-color: rgba(212,168,67,0.12); }
    .match-item.matched { border-color: var(--color-success); background-color: rgba(45,138,78,0.10); pointer-events: none; opacity: 0.7; }
    .match-item.wrong { border-color: var(--color-error); animation: shake 0.4s ease; }
    .match-col-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-secondary); text-align: center; margin-bottom: 6px; }

    /* ============================================
       BOTTOM ACTION BAR
       ============================================ */
    .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-page); border-top: 1px solid var(--border); padding: 16px 20px; z-index: 90; padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .action-bar-inner { max-width: 600px; margin: 0 auto; display: flex; gap: 10px; }
    .btn-check { flex: 1; padding: 14px 24px; border: none; border-radius: var(--radius-md); font-family: var(--font-body); font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.15s, opacity 0.3s; }
    .btn-check:active { transform: translateY(1px); }
    .btn-check.primary { background-color: var(--color-primary); color: #FDF8F3; }
    [data-theme="dark"] .btn-check.primary { background-color: var(--color-accent); color: #1A2A1F; }
    .btn-check.primary:hover { background-color: var(--color-primary-hover); }
    [data-theme="dark"] .btn-check.primary:hover { background-color: var(--color-accent-hover); }
    .btn-check:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .btn-check.skip { background: none; border: 1px solid var(--border); color: var(--text-secondary); flex: 0 0 auto; padding: 14px 18px; }
    .btn-check.skip:hover { background-color: var(--bg-surface); }

    /* ============================================
       FEEDBACK DRAWER (inline S7)
       ============================================ */
    .feedback-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.3); z-index: 150; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .feedback-overlay.open { opacity: 1; pointer-events: auto; }
    .feedback-drawer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 151; border-radius: var(--radius-xl) var(--radius-xl) 0 0; padding: 24px 20px; padding-bottom: max(24px, env(safe-area-inset-bottom)); transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
    .feedback-drawer.open { transform: translateY(0); }
    .feedback-drawer.correct { background-color: #E8F5EB; border-top: 3px solid var(--color-success); }
    [data-theme="dark"] .feedback-drawer.correct { background-color: #1A3A26; border-top-color: var(--color-success); }
    .feedback-drawer.wrong { background-color: #FDECEA; border-top: 3px solid var(--color-error); }
    [data-theme="dark"] .feedback-drawer.wrong { background-color: #3A1A1A; border-top-color: var(--color-error); }
    .feedback-inner { max-width: 600px; margin: 0 auto; }
    .feedback-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .feedback-icon { width: 28px; height: 28px; flex-shrink: 0; }
    .feedback-icon.correct-icon { color: var(--color-success); }
    .feedback-icon.wrong-icon { color: var(--color-error); display: none; }
    .feedback-drawer.wrong .feedback-icon.correct-icon { display: none; }
    .feedback-drawer.wrong .feedback-icon.wrong-icon { display: block; }
    .feedback-drawer.correct .feedback-icon.correct-icon { display: block; }
    .feedback-drawer.correct .feedback-icon.wrong-icon { display: none; }
    .feedback-title { font-family: var(--font-heading); font-weight: 700; font-size: 18px; }
    .feedback-drawer.correct .feedback-title { color: var(--color-success); }
    .feedback-drawer.wrong .feedback-title { color: var(--color-error); }
    .feedback-explanation { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
    .feedback-btn { width: 100%; padding: 14px; border: none; border-radius: var(--radius-md); font-family: var(--font-body); font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    .feedback-drawer.correct .feedback-btn { background-color: var(--color-success); color: #FDF8F3; }
    .feedback-drawer.correct .feedback-btn:hover { background-color: #258A42; }
    .feedback-drawer.wrong .feedback-btn { background-color: var(--color-error); color: #FDF8F3; }
    .feedback-drawer.wrong .feedback-btn:hover { background-color: #C33C3C; }

    /* ============================================
       LESSON COMPLETE
       ============================================ */
    .lesson-complete { display: none; flex-direction: column; align-items: center; text-align: center; padding: 40px 20px 120px; max-width: 600px; margin: 0 auto; width: 100%; }
    .lesson-complete.visible { display: flex; }
    .complete-celebration { font-size: 56px; margin-bottom: 16px; animation: bounceIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    .complete-title { font-family: var(--font-heading); font-weight: 800; font-size: 26px; color: var(--text-primary); margin-bottom: 6px; }
    .complete-subtitle { font-size: 15px; color: var(--text-secondary); margin-bottom: 32px; }
    .complete-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; margin-bottom: 32px; }
    .stat-card { background-color: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px 12px; }
    .stat-value { font-family: var(--font-heading); font-weight: 800; font-size: 28px; color: var(--color-primary); margin-bottom: 4px; }
    [data-theme="dark"] .stat-value { color: var(--color-accent); }
    .stat-value.xp { color: var(--color-accent); }
    .stat-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
    .complete-words { width: 100%; text-align: left; margin-bottom: 32px; }
    .complete-words-title { font-family: var(--font-heading); font-weight: 700; font-size: 16px; margin-bottom: 12px; color: var(--text-primary); }
    .complete-words-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .word-learned { padding: 6px 14px; border-radius: 20px; background-color: var(--bg-surface); border: 1px solid var(--border); font-size: 14px; font-weight: 500; color: var(--text-primary); }
    .word-learned .word-en { color: var(--text-secondary); font-weight: 400; margin-left: 4px; }
    .complete-actions { display: flex; flex-direction: column; gap: 10px; width: 100%; }
    .complete-btn { padding: 14px 24px; border: none; border-radius: var(--radius-md); font-family: var(--font-body); font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.15s; text-decoration: none; display: block; text-align: center; }
    .complete-btn:active { transform: translateY(1px); }
    .complete-btn.primary { background-color: var(--color-primary); color: #FDF8F3; }
    [data-theme="dark"] .complete-btn.primary { background-color: var(--color-accent); color: #1A2A1F; }
    .complete-btn.secondary { background-color: var(--bg-surface); border: 1px solid var(--border); color: var(--text-primary); }
    .complete-btn.secondary:hover { background-color: var(--border); }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-6px); } 40% { transform: translateX(6px); } 60% { transform: translateX(-4px); } 80% { transform: translateX(4px); } }
    @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.08); } 70% { transform: scale(0.95); } 100% { transform: scale(1); opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .anim-slide { animation: slideUp 0.4s ease-out both; }

    /* ============================================
       RESPONSIVE
       ============================================ */
    @media (min-width: 768px) {
      .activity-instruction { font-size: 22px; }
      .flashcard { height: 240px; }
    }
    @media (max-width: 360px) {
      .matching-container { gap: 6px; }
      .match-item { padding: 10px 8px; font-size: 13px; }
      .complete-stats { grid-template-columns: 1fr; }
    }
    @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }
  </style>
</head>
<body>

  <!-- ============================================
       PLAYER HEADER — progress + close
       ============================================ -->
  <header class="player-header">
    <div class="player-header-row">
      <a href="S5-lesson-view.html" class="close-btn" id="close-btn" title="Exit lesson">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </a>
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <span class="progress-text" id="progress-text">0/8</span>
      </div>
    </div>
  </header>

  <!-- ============================================
       ACTIVITY CONTENT AREA
       ============================================ -->
  <main class="player-main" id="player-main">
    <!-- Activities render here via JS -->
  </main>

  <!-- ============================================
       BOTTOM ACTION BAR
       ============================================ -->
  <div class="action-bar" id="action-bar">
    <div class="action-bar-inner">
      <button class="btn-check skip" id="btn-skip">Skip</button>
      <button class="btn-check primary" id="btn-check" disabled>Check</button>
    </div>
  </div>

  <!-- ============================================
       FEEDBACK DRAWER (inline S7)
       ============================================ -->
  <div class="feedback-overlay" id="feedback-overlay"></div>
  <div class="feedback-drawer" id="feedback-drawer">
    <div class="feedback-inner">
      <div class="feedback-header">
        <!-- Correct icon (checkmark circle) -->
        <svg class="feedback-icon correct-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="9 12 11.5 14.5 16 10"/></svg>
        <!-- Wrong icon (x circle) -->
        <svg class="feedback-icon wrong-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        <span class="feedback-title" id="feedback-title"></span>
      </div>
      <div class="feedback-explanation" id="feedback-explanation"></div>
      <button class="feedback-btn" id="feedback-btn">Continue</button>
    </div>
  </div>

  <!-- ============================================
       LESSON COMPLETE (S8 inline)
       ============================================ -->
  <section class="lesson-complete" id="lesson-complete">
    <div class="complete-celebration">&#127775;</div>
    <h1 class="complete-title">Pîroz be!</h1>
    <p class="complete-subtitle">You completed "Tu çawa yî?"</p>
    <div class="complete-stats">
      <div class="stat-card anim-slide" style="animation-delay:0.1s">
        <div class="stat-value xp" id="stat-xp">+50</div>
        <div class="stat-label">XP earned</div>
      </div>
      <div class="stat-card anim-slide" style="animation-delay:0.2s">
        <div class="stat-value" id="stat-accuracy">0%</div>
        <div class="stat-label">Accuracy</div>
      </div>
      <div class="stat-card anim-slide" style="animation-delay:0.3s">
        <div class="stat-value" id="stat-time">0:00</div>
        <div class="stat-label">Time</div>
      </div>
    </div>
    <div class="complete-words anim-slide" style="animation-delay:0.35s">
      <div class="complete-words-title">Words learned</div>
      <div class="complete-words-list" id="words-list"></div>
    </div>
    <div class="complete-actions anim-slide" style="animation-delay:0.4s">
      <a href="S4-unit-view.html" class="complete-btn primary">Next Lesson</a>
      <a href="S4-unit-view.html" class="complete-btn secondary">Back to Unit</a>
    </div>
  </section>

  <script>
  (function () {
    'use strict';

    // ============================================================
    // Theme init (same as other screens)
    // ============================================================
    var html = document.documentElement;
    var saved = localStorage.getItem('hk-theme');
    if (saved) {
      if (saved === 'light') html.removeAttribute('data-theme');
      else html.setAttribute('data-theme', saved);
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      html.setAttribute('data-theme', 'dark');
    }

    // ============================================================
    // Lesson data — "Tu çawa yî?" from Mamoste's material (page 24)
    // 8 activities: 3 flashcard, 1 reading, 2 mcq, 1 gap_fill, 1 matching
    // ============================================================
    var ACTIVITIES = [
      {
        type: 'flashcard',
        instruction: 'Learn this word',
        word: 'çawa',
        hint: 'Tap to flip',
        translation: 'how',
        example: 'Tu çawa yî? — How are you?'
      },
      {
        type: 'flashcard',
        instruction: 'Learn this word',
        word: 'baş',
        hint: 'Tap to flip',
        translation: 'good / well',
        example: 'Ez baş im. — I am good.'
      },
      {
        type: 'flashcard',
        instruction: 'Learn this word',
        word: 'spas',
        hint: 'Tap to flip',
        translation: 'thanks',
        example: 'Spas, ez baş im. — Thanks, I am good.'
      },
      {
        type: 'reading',
        instruction: 'Read the dialogue',
        title: 'Roj baş — Good day',
        lines: [
          { speaker: 'Azad', ku: 'Roj baş! Ez Azad im.', en: 'Good day! I am Azad.' },
          { speaker: 'Delal', ku: 'Roj baş! Ez Delal im.', en: 'Good day! I am Delal.' },
          { speaker: 'Azad', ku: 'Tu çawa yî?', en: 'How are you?' },
          { speaker: 'Delal', ku: 'Spas, ez baş im. Tu çawa yî?', en: 'Thanks, I am good. How are you?' },
          { speaker: 'Azad', ku: 'Ez jî baş im, spas.', en: 'I am also good, thanks.' }
        ]
      },
      {
        type: 'mcq',
        instruction: 'What does "spas" mean?',
        options: ['Hello', 'Thanks', 'Good', 'How'],
        correct: 1,
        explanation: '"Spas" means "thanks" in Kurdish. Example: Spas, ez baş im.'
      },
      {
        type: 'gap_fill',
        instruction: 'Fill in the blank',
        before: 'Ez ',
        gap: 'baş',
        after: ' im.',
        display: 'Ez ___ im.',
        wordBank: ['nexweş', 'baş', 'çawa', 'spas'],
        explanation: '"Ez baş im" means "I am good."'
      },
      {
        type: 'mcq',
        instruction: 'What does "Êvar baş" mean?',
        options: ['Good morning', 'Good day', 'Good evening', 'Good night'],
        correct: 2,
        explanation: '"Êvar baş" means "Good evening." From the greeting family: Beyani baş, Roj baş, Êvar baş, Şev baş.'
      },
      {
        type: 'matching',
        instruction: 'Match the pairs',
        pairs: [
          { ku: 'Roj baş', en: 'Good day' },
          { ku: 'Şev baş', en: 'Good night' },
          { ku: 'Spas', en: 'Thanks' },
          { ku: 'Çawa', en: 'How' }
        ]
      }
    ];

    var WORDS_LEARNED = [
      { ku: 'çawa', en: 'how' },
      { ku: 'baş', en: 'good' },
      { ku: 'spas', en: 'thanks' },
      { ku: 'roj baş', en: 'good day' },
      { ku: 'êvar baş', en: 'good evening' },
      { ku: 'şev baş', en: 'good night' }
    ];

    // ============================================================
    // State
    // ============================================================
    var currentIndex = 0;
    var totalActivities = ACTIVITIES.length;
    var correctCount = 0;
    var answeredCount = 0;
    var userAnswer = null;
    var isChecked = false;
    var startTime = Date.now();

    // DOM refs
    var playerMain = document.getElementById('player-main');
    var progressFill = document.getElementById('progress-fill');
    var progressText = document.getElementById('progress-text');
    var btnCheck = document.getElementById('btn-check');
    var btnSkip = document.getElementById('btn-skip');
    var actionBar = document.getElementById('action-bar');
    var feedbackOverlay = document.getElementById('feedback-overlay');
    var feedbackDrawer = document.getElementById('feedback-drawer');
    var feedbackTitle = document.getElementById('feedback-title');
    var feedbackExplanation = document.getElementById('feedback-explanation');
    var feedbackBtn = document.getElementById('feedback-btn');
    var lessonComplete = document.getElementById('lesson-complete');

    // ============================================================
    // Helpers
    // ============================================================
    function el(tag, attrs, children) {
      var node = document.createElement(tag);
      if (attrs) {
        for (var key in attrs) {
          if (key === 'className') node.className = attrs[key];
          else if (key === 'textContent') node.textContent = attrs[key];
          else node.setAttribute(key, attrs[key]);
        }
      }
      if (children) {
        for (var i = 0; i < children.length; i++) {
          if (typeof children[i] === 'string') {
            node.appendChild(document.createTextNode(children[i]));
          } else if (children[i]) {
            node.appendChild(children[i]);
          }
        }
      }
      return node;
    }

    function updateProgress() {
      var pct = (currentIndex / totalActivities) * 100;
      progressFill.style.width = pct + '%';
      progressText.textContent = currentIndex + '/' + totalActivities;
    }

    function setCheckEnabled(enabled) {
      btnCheck.disabled = !enabled;
    }

    function clearMain() {
      while (playerMain.firstChild) playerMain.removeChild(playerMain.firstChild);
    }

    // Create a listen/audio button (speaker icon) — placeholder for TTS
    function createListenBtn(extraClass) {
      var btn = document.createElement('button');
      btn.className = 'listen-btn' + (extraClass ? ' ' + extraClass : '');
      btn.setAttribute('aria-label', 'Listen');
      btn.setAttribute('title', 'Listen');
      var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');
      svg.setAttribute('stroke', 'currentColor');
      svg.setAttribute('stroke-width', '2');
      svg.setAttribute('stroke-linecap', 'round');
      svg.setAttribute('stroke-linejoin', 'round');
      var poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      poly.setAttribute('points', '11 5 6 9 2 9 2 15 6 15 11 19 11 5');
      var wave = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      wave.setAttribute('d', 'M15.54 8.46a5 5 0 0 1 0 7.07');
      svg.appendChild(poly);
      svg.appendChild(wave);
      btn.appendChild(svg);
      // Placeholder click — brief pulse animation
      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        btn.classList.add('playing');
        setTimeout(function () { btn.classList.remove('playing'); }, 800);
      });
      return btn;
    }

    // ============================================================
    // Render: Flashcard
    // ============================================================
    function renderFlashcard(act) {
      var badge = el('div', { className: 'activity-type-badge anim-slide', textContent: 'Flashcard' });
      var instruction = el('div', { className: 'activity-instruction anim-slide', textContent: act.instruction });
      instruction.style.animationDelay = '0.05s';

      var container = el('div', { className: 'flashcard-container anim-slide' });
      container.style.animationDelay = '0.1s';
      var card = el('div', { className: 'flashcard' });

      var front = el('div', { className: 'flashcard-face flashcard-front' });
      var wordRow = el('div', { className: 'flashcard-word-row' });
      wordRow.appendChild(el('div', { className: 'flashcard-word', textContent: act.word }));
      wordRow.appendChild(createListenBtn());
      front.appendChild(wordRow);
      front.appendChild(el('div', { className: 'flashcard-hint', textContent: act.hint }));

      var back = el('div', { className: 'flashcard-face flashcard-back' });
      var transRow = el('div', { className: 'flashcard-translation-row' });
      transRow.appendChild(el('div', { className: 'flashcard-translation', textContent: act.translation }));
      back.appendChild(transRow);
      var exampleRow = el('div', { className: 'flashcard-translation-row' });
      exampleRow.appendChild(el('div', { className: 'flashcard-example', textContent: act.example }));
      exampleRow.appendChild(createListenBtn('listen-sm listen-light'));
      back.appendChild(exampleRow);

      card.appendChild(front);
      card.appendChild(back);
      container.appendChild(card);

      var tapHint = el('div', { className: 'flashcard-tap-hint anim-slide', textContent: 'Tap the card to see the translation' });
      tapHint.style.animationDelay = '0.15s';

      var flipped = false;
      card.addEventListener('click', function () {
        flipped = !flipped;
        card.classList.toggle('flipped', flipped);
        if (flipped) {
          userAnswer = 'seen';
          setCheckEnabled(true);
          btnCheck.textContent = 'Got it';
          tapHint.textContent = 'Tap again to review';
        } else {
          tapHint.textContent = 'Tap the card to see the translation';
        }
      });

      playerMain.appendChild(badge);
      playerMain.appendChild(instruction);
      playerMain.appendChild(container);
      playerMain.appendChild(tapHint);

      btnCheck.textContent = 'Got it';
      btnSkip.style.display = 'none';
      setCheckEnabled(false);
    }

    // ============================================================
    // Render: Reading / Dialogue
    // ============================================================
    function renderReading(act) {
      var badge = el('div', { className: 'activity-type-badge anim-slide', textContent: 'Dialogue' });
      var instruction = el('div', { className: 'activity-instruction anim-slide', textContent: act.instruction });
      instruction.style.animationDelay = '0.05s';

      var card = el('div', { className: 'dialogue-card anim-slide' });
      card.style.animationDelay = '0.1s';
      card.appendChild(el('div', { className: 'dialogue-title', textContent: act.title }));

      for (var i = 0; i < act.lines.length; i++) {
        var line = act.lines[i];
        var lineEl = el('div', { className: 'dialogue-line' });
        lineEl.style.animationDelay = (0.15 + i * 0.08) + 's';
        lineEl.classList.add('anim-slide');
        lineEl.appendChild(el('div', { className: 'dialogue-speaker', textContent: line.speaker }));
        var bubble = el('div', { className: 'dialogue-bubble' });
        var kuRow = el('div', { className: 'dialogue-ku-row' });
        kuRow.appendChild(el('span', { className: 'dialogue-ku', textContent: line.ku }));
        kuRow.appendChild(createListenBtn('listen-sm'));
        bubble.appendChild(kuRow);
        bubble.appendChild(el('div', { className: 'dialogue-en', textContent: line.en }));
        lineEl.appendChild(bubble);
        card.appendChild(lineEl);
      }

      playerMain.appendChild(badge);
      playerMain.appendChild(instruction);
      playerMain.appendChild(card);

      // Reading has no right/wrong — just "Continue"
      userAnswer = 'read';
      btnCheck.textContent = 'Continue';
      btnSkip.style.display = 'none';
      setCheckEnabled(true);
    }

    // ============================================================
    // Render: MCQ
    // ============================================================
    function renderMCQ(act) {
      var badge = el('div', { className: 'activity-type-badge anim-slide', textContent: 'Multiple Choice' });
      var instruction = el('div', { className: 'activity-instruction anim-slide' });
      instruction.appendChild(document.createTextNode(act.instruction));
      // Add listen icon if instruction contains Kurdish text (quotes indicate Kurdish)
      if (act.instruction.indexOf('\u201C') !== -1 || act.instruction.indexOf('"') !== -1) {
        instruction.appendChild(document.createTextNode(' '));
        instruction.appendChild(createListenBtn('listen-sm'));
      }
      instruction.style.animationDelay = '0.05s';

      var optionsWrap = el('div', { className: 'mcq-options' });
      var letters = ['A', 'B', 'C', 'D'];

      for (var i = 0; i < act.options.length; i++) {
        (function (idx) {
          var opt = el('button', { className: 'mcq-option anim-slide' });
          opt.style.animationDelay = (0.1 + idx * 0.06) + 's';
          opt.appendChild(el('span', { className: 'mcq-letter', textContent: letters[idx] }));
          opt.appendChild(el('span', { textContent: act.options[idx] }));
          opt.addEventListener('click', function () {
            if (isChecked) return;
            var all = optionsWrap.querySelectorAll('.mcq-option');
            for (var j = 0; j < all.length; j++) all[j].classList.remove('selected');
            opt.classList.add('selected');
            userAnswer = idx;
            setCheckEnabled(true);
          });
          optionsWrap.appendChild(opt);
        })(i);
      }

      playerMain.appendChild(badge);
      playerMain.appendChild(instruction);
      playerMain.appendChild(optionsWrap);

      btnCheck.textContent = 'Check';
      btnSkip.style.display = '';
      setCheckEnabled(false);
    }

    // ============================================================
    // Render: Gap Fill
    // ============================================================
    function renderGapFill(act) {
      var badge = el('div', { className: 'activity-type-badge anim-slide', textContent: 'Fill the Gap' });
      var instruction = el('div', { className: 'activity-instruction anim-slide', textContent: act.instruction });
      instruction.style.animationDelay = '0.05s';

      var sentenceRow = el('div', { className: 'gapfill-row anim-slide' });
      sentenceRow.style.animationDelay = '0.1s';

      var sentenceEl = el('div', { className: 'gapfill-sentence' });
      // Build "Ez ___ im." with a gap slot
      var beforeText = document.createTextNode(act.before);
      var gapSlot = el('span', { className: 'gap-slot', id: 'gap-slot' });
      gapSlot.textContent = '\u00A0\u00A0\u00A0';
      var afterText = document.createTextNode(act.after);
      sentenceEl.appendChild(beforeText);
      sentenceEl.appendChild(gapSlot);
      sentenceEl.appendChild(afterText);
      sentenceRow.appendChild(sentenceEl);
      sentenceRow.appendChild(createListenBtn());

      var wordBank = el('div', { className: 'word-bank anim-slide' });
      wordBank.style.animationDelay = '0.15s';

      // Shuffle word bank
      var shuffled = act.wordBank.slice().sort(function () { return Math.random() - 0.5; });

      for (var i = 0; i < shuffled.length; i++) {
        (function (word) {
          var chip = el('button', { className: 'word-chip', textContent: word });
          chip.addEventListener('click', function () {
            if (isChecked) return;
            // Reset previous selection
            var allChips = wordBank.querySelectorAll('.word-chip');
            for (var j = 0; j < allChips.length; j++) allChips[j].classList.remove('used');
            chip.classList.add('used');
            gapSlot.textContent = word;
            gapSlot.classList.add('filled');
            userAnswer = word;
            setCheckEnabled(true);
          });
          wordBank.appendChild(chip);
        })(shuffled[i]);
      }

      // Tap gap to clear
      gapSlot.addEventListener('click', function () {
        if (isChecked) return;
        gapSlot.textContent = '\u00A0\u00A0\u00A0';
        gapSlot.classList.remove('filled');
        var allChips = wordBank.querySelectorAll('.word-chip');
        for (var j = 0; j < allChips.length; j++) allChips[j].classList.remove('used');
        userAnswer = null;
        setCheckEnabled(false);
      });

      playerMain.appendChild(badge);
      playerMain.appendChild(instruction);
      playerMain.appendChild(sentenceRow);
      playerMain.appendChild(wordBank);

      btnCheck.textContent = 'Check';
      btnSkip.style.display = '';
      setCheckEnabled(false);
    }

    // ============================================================
    // Render: Matching
    // ============================================================
    function renderMatching(act) {
      var badge = el('div', { className: 'activity-type-badge anim-slide', textContent: 'Matching' });
      var instruction = el('div', { className: 'activity-instruction anim-slide', textContent: act.instruction });
      instruction.style.animationDelay = '0.05s';

      var colLabels = el('div', { className: 'matching-container anim-slide' });
      colLabels.style.animationDelay = '0.1s';
      colLabels.appendChild(el('div', { className: 'match-col-label', textContent: 'Kurdî' }));
      colLabels.appendChild(el('div', { className: 'match-col-label', textContent: 'English' }));

      var grid = el('div', { className: 'matching-container anim-slide' });
      grid.style.animationDelay = '0.15s';

      // Shuffle EN side
      var kuItems = act.pairs.map(function (p) { return p.ku; });
      var enItems = act.pairs.map(function (p) { return p.en; }).sort(function () { return Math.random() - 0.5; });

      var selectedKu = null;
      var selectedEn = null;
      var matchedPairs = 0;
      var totalPairs = act.pairs.length;
      var matchAttempts = 0;
      var matchCorrect = 0;

      function checkMatch() {
        if (!selectedKu || !selectedEn) return;
        matchAttempts++;
        // Find correct EN for selectedKu
        var correctEn = null;
        for (var i = 0; i < act.pairs.length; i++) {
          if (act.pairs[i].ku === selectedKu.dataset.word) {
            correctEn = act.pairs[i].en;
            break;
          }
        }
        if (selectedEn.dataset.word === correctEn) {
          matchCorrect++;
          selectedKu.classList.remove('selected');
          selectedEn.classList.remove('selected');
          selectedKu.classList.add('matched');
          selectedEn.classList.add('matched');
          matchedPairs++;
          if (matchedPairs === totalPairs) {
            userAnswer = { attempts: matchAttempts, correct: matchCorrect };
            setCheckEnabled(true);
            btnCheck.textContent = 'Continue';
          }
        } else {
          selectedKu.classList.add('wrong');
          selectedEn.classList.add('wrong');
          var kuRef = selectedKu;
          var enRef = selectedEn;
          setTimeout(function () {
            kuRef.classList.remove('wrong', 'selected');
            enRef.classList.remove('wrong', 'selected');
          }, 500);
        }
        selectedKu = null;
        selectedEn = null;
      }

      for (var i = 0; i < kuItems.length; i++) {
        (function (idx) {
          var kuBtn = el('button', { className: 'match-item' });
          var kuInner = el('span', { className: 'match-item-inner' });
          kuInner.appendChild(document.createTextNode(kuItems[idx]));
          kuInner.appendChild(createListenBtn('listen-sm'));
          kuBtn.appendChild(kuInner);
          kuBtn.dataset.word = kuItems[idx];
          kuBtn.dataset.side = 'ku';
          kuBtn.addEventListener('click', function () {
            if (kuBtn.classList.contains('matched')) return;
            var kuAll = grid.querySelectorAll('[data-side="ku"]');
            for (var j = 0; j < kuAll.length; j++) {
              if (!kuAll[j].classList.contains('matched')) kuAll[j].classList.remove('selected');
            }
            kuBtn.classList.add('selected');
            selectedKu = kuBtn;
            checkMatch();
          });

          var enBtn = el('button', { className: 'match-item', textContent: enItems[idx] });
          enBtn.dataset.word = enItems[idx];
          enBtn.dataset.side = 'en';
          enBtn.addEventListener('click', function () {
            if (enBtn.classList.contains('matched')) return;
            var enAll = grid.querySelectorAll('[data-side="en"]');
            for (var j = 0; j < enAll.length; j++) {
              if (!enAll[j].classList.contains('matched')) enAll[j].classList.remove('selected');
            }
            enBtn.classList.add('selected');
            selectedEn = enBtn;
            checkMatch();
          });

          grid.appendChild(kuBtn);
          grid.appendChild(enBtn);
        })(i);
      }

      playerMain.appendChild(badge);
      playerMain.appendChild(instruction);
      playerMain.appendChild(colLabels);
      playerMain.appendChild(grid);

      btnCheck.textContent = 'Check';
      btnSkip.style.display = '';
      setCheckEnabled(false);
    }

    // ============================================================
    // Show feedback drawer
    // ============================================================
    function showFeedback(correct, explanation, callback) {
      feedbackDrawer.classList.remove('correct', 'wrong');
      feedbackDrawer.classList.add(correct ? 'correct' : 'wrong');

      feedbackTitle.textContent = correct ? 'Rast e! — Correct!' : 'Ne rast e — Incorrect';
      feedbackExplanation.textContent = explanation || '';
      feedbackBtn.textContent = 'Continue';

      feedbackOverlay.classList.add('open');
      feedbackDrawer.classList.add('open');
      actionBar.style.display = 'none';

      function onContinue() {
        feedbackOverlay.classList.remove('open');
        feedbackDrawer.classList.remove('open');
        actionBar.style.display = '';
        feedbackBtn.removeEventListener('click', onContinue);
        if (callback) callback();
      }
      feedbackBtn.addEventListener('click', onContinue);
    }

    // ============================================================
    // Show lesson complete
    // ============================================================
    function showLessonComplete() {
      playerMain.style.display = 'none';
      actionBar.style.display = 'none';
      document.querySelector('.player-header').style.display = 'none';

      var elapsed = Math.floor((Date.now() - startTime) / 1000);
      var mins = Math.floor(elapsed / 60);
      var secs = elapsed % 60;
      var accuracy = answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 100;

      document.getElementById('stat-xp').textContent = '+50';
      document.getElementById('stat-accuracy').textContent = accuracy + '%';
      document.getElementById('stat-time').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;

      var wordsList = document.getElementById('words-list');
      while (wordsList.firstChild) wordsList.removeChild(wordsList.firstChild);
      for (var i = 0; i < WORDS_LEARNED.length; i++) {
        var w = WORDS_LEARNED[i];
        var tag = el('span', { className: 'word-learned' });
        tag.appendChild(document.createTextNode(w.ku));
        tag.appendChild(el('span', { className: 'word-en', textContent: ' \u2014 ' + w.en }));
        wordsList.appendChild(tag);
      }

      lessonComplete.classList.add('visible');
      // Update progress to 100%
      progressFill.style.width = '100%';
      progressText.textContent = totalActivities + '/' + totalActivities;
    }

    // ============================================================
    // Render current activity
    // ============================================================
    function renderActivity() {
      clearMain();
      userAnswer = null;
      isChecked = false;
      updateProgress();

      if (currentIndex >= totalActivities) {
        showLessonComplete();
        return;
      }

      var act = ACTIVITIES[currentIndex];

      switch (act.type) {
        case 'flashcard': renderFlashcard(act); break;
        case 'reading':   renderReading(act); break;
        case 'mcq':       renderMCQ(act); break;
        case 'gap_fill':  renderGapFill(act); break;
        case 'matching':  renderMatching(act); break;
      }
    }

    // ============================================================
    // Check answer
    // ============================================================
    function checkAnswer() {
      var act = ACTIVITIES[currentIndex];

      // Flashcard and reading — no right/wrong, just advance
      if (act.type === 'flashcard' || act.type === 'reading') {
        currentIndex++;
        renderActivity();
        return;
      }

      // Matching — feedback based on performance
      if (act.type === 'matching') {
        if (userAnswer && userAnswer.attempts) {
          answeredCount++;
          var wasClean = userAnswer.attempts === userAnswer.correct;
          if (wasClean) correctCount++;
          showFeedback(wasClean,
            wasClean ? 'Perfect matching! You got all pairs right.' : 'Some pairs took extra tries. Keep practicing!',
            function () {
              currentIndex++;
              renderActivity();
            }
          );
          return;
        }
        currentIndex++;
        renderActivity();
        return;
      }

      isChecked = true;
      answeredCount++;

      if (act.type === 'mcq') {
        var correct = userAnswer === act.correct;
        if (correct) correctCount++;
        var opts = playerMain.querySelectorAll('.mcq-option');
        if (correct) {
          opts[userAnswer].classList.add('correct');
        } else {
          opts[userAnswer].classList.add('wrong');
          opts[act.correct].classList.add('correct');
        }
        showFeedback(correct, act.explanation, function () {
          currentIndex++;
          renderActivity();
        });
      }

      if (act.type === 'gap_fill') {
        var gapCorrect = userAnswer === act.gap;
        if (gapCorrect) correctCount++;
        var slot = document.getElementById('gap-slot');
        if (gapCorrect) {
          slot.classList.add('filled');
        } else {
          slot.classList.add('wrong');
        }
        showFeedback(gapCorrect, act.explanation, function () {
          currentIndex++;
          renderActivity();
        });
      }
    }

    // ============================================================
    // Event listeners
    // ============================================================
    btnCheck.addEventListener('click', function () {
      if (!btnCheck.disabled) checkAnswer();
    });

    btnSkip.addEventListener('click', function () {
      answeredCount++;
      currentIndex++;
      renderActivity();
    });

    // ============================================================
    // Init
    // ============================================================
    renderActivity();

  })();
  </script>
</body>
</html>
