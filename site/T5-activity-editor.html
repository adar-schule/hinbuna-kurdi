<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <!-- Generated by Claude Code · Hinbûna Kurdî Design System · Activity Editor · Responsive -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activities — Silav — Hinbûna Kurdî</title>
  <meta name="description" content="Mamoste activity editor. Create and edit learning activities — MCQ, gap fill, matching, flashcards, listening.">
  <!-- Kurdish Sun Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='none'/%3E%3Cpolygon points='50.0,5.0 53.0,30.2 63.3,7.0 58.7,32.0 75.3,12.8 63.6,35.3 85.2,21.9 67.3,40.0 91.9,33.6 69.5,45.6 94.9,46.6 69.9,51.5 93.9,60.0 68.6,57.3 89.0,72.5 65.6,62.5 80.6,83.0 61.3,66.5 69.5,90.5 55.9,69.1 56.7,94.5 50.0,70.0 43.3,94.5 44.1,69.1 30.5,90.5 38.7,66.5 19.4,83.0 34.4,62.5 11.0,72.5 31.4,57.3 6.1,60.0 30.1,51.5 5.1,46.6 30.5,45.6 8.1,33.6 32.7,40.0 14.8,21.9 36.4,35.3 24.7,12.8 41.3,32.0 36.7,7.0 47.0,30.2' fill='%23D4A843'/%3E%3Ccircle cx='50' cy='50' r='16' fill='%23D4A843'/%3E%3C/svg%3E">

  <!-- Fonts: Inter + Nunito (self-hosted) -->
  <link rel="stylesheet" href="shared/fonts.css">

  <!-- Shared theme system -->
  <script src="shared/theme.js"></script>
  <link rel="stylesheet" href="shared/settings.css">
  <link rel="stylesheet" href="shared/header.css">
  <link rel="stylesheet" href="shared/student-menu.css">

  <style>
    /* ============================================
       DESIGN TOKENS — Hinbûna Kurdî Brand System
       ============================================ */
    :root {
      --bg-page: #FDF8F3;
      --bg-surface: #F5EEE6;
      --color-primary: #2D5A3D;
      --color-primary-hover: #24493A;
      --color-accent: #D4A843;
      --color-accent-hover: #c99b3a;
      --color-tan: #E3C79D;
      --text-primary: #1A2A1F;
      --text-secondary: #5A6B5E;
      --border: #E5DDD3;
      --color-success: #2D8A4E;
      --color-error: #DC4545;
      --color-warning: #EFB034;
      --color-info: #3B7A8A;

      --shadow-sm: 0 1px 3px rgba(26, 42, 31, 0.06);
      --shadow-md: 0 4px 12px rgba(26, 42, 31, 0.08);
      --shadow-lg: 0 8px 24px rgba(26, 42, 31, 0.10);

      --font-heading: 'Nunito', sans-serif;
      --font-body: 'Inter', sans-serif;

      --radius-xs: 4px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --stripe-height: 2px;
    }

    [data-theme="dark"] {
      --bg-page: #1A2F23;
      --bg-surface: #243D30;
      --color-primary: #2D5A3D;
      --color-primary-hover: #367248;
      --color-accent: #D4A843;
      --color-accent-hover: #e0b64e;
      --color-tan: #3A5E45;
      --text-primary: #F5EEE6;
      --text-secondary: #A8B5AC;
      --border: #2F4F3A;
      --color-success: #3DA863;
      --color-error: #E85858;
      --color-warning: #EFB034;
      --color-info: #4D9AAE;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.25);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    /* ============================================
       RESET & BASE
       ============================================ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    body { font-family: var(--font-body); font-weight: 400; font-size: 15px; line-height: 1.6; color: var(--text-primary); background-color: var(--bg-page); overflow-x: hidden; min-height: 100vh; }
    a { text-decoration: none; color: inherit; }

    .page-content { max-width: 600px; margin: 0 auto; padding: 20px 20px 40px; }

    /* ============================================
       BREADCRUMB
       ============================================ */
    .breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; flex-wrap: wrap; }
    .breadcrumb a { color: var(--text-secondary); transition: color 0.2s ease; }
    .breadcrumb a:hover { color: var(--color-primary); }
    [data-theme="dark"] .breadcrumb a:hover { color: var(--color-accent); }
    .breadcrumb svg { width: 12px; height: 12px; flex-shrink: 0; opacity: 0.5; }
    .breadcrumb-current { color: var(--text-primary); font-weight: 600; }

    /* ============================================
       LESSON HEADER CARD
       ============================================ */
    .lesson-header-card {
      background-color: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 18px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .lesson-header-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: var(--stripe-height);
      background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
    }

    .lesson-header-top { display: flex; align-items: flex-start; gap: 14px; }

    .lesson-number-icon {
      width: 44px; height: 44px;
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      font-size: 14px; font-weight: 800; font-family: var(--font-heading);
      background-color: rgba(59, 122, 138, 0.08);
      color: var(--color-info);
    }

    [data-theme="dark"] .lesson-number-icon { background-color: rgba(77, 154, 174, 0.15); }

    .lesson-header-info { flex: 1; min-width: 0; }
    .lesson-header-name { font-family: var(--font-heading); font-weight: 700; font-size: 18px; color: var(--text-primary); line-height: 1.3; }
    .lesson-header-path { font-size: 12px; color: var(--text-secondary); margin-top: 1px; }
    .lesson-header-objective { font-size: 13px; color: var(--text-secondary); margin-top: 8px; line-height: 1.5; font-style: italic; padding: 8px 12px; background-color: var(--bg-page); border-radius: var(--radius-sm); border-left: 3px solid var(--color-accent); }

    .lesson-header-stats { display: flex; gap: 14px; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
    .lesson-stat { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .lesson-stat-value { font-family: var(--font-heading); font-weight: 800; font-size: 18px; color: var(--text-primary); line-height: 1.1; }
    .lesson-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    .lesson-stat-divider { width: 1px; background-color: var(--border); align-self: stretch; }

    .status-pill { display: inline-flex; align-items: center; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 7px; border-radius: 20px; flex-shrink: 0; }
    .status-pill.published { background-color: rgba(45, 138, 78, 0.1); color: var(--color-success); }
    [data-theme="dark"] .status-pill.published { background-color: rgba(61, 168, 99, 0.15); }
    .status-pill.draft { background-color: rgba(239, 176, 52, 0.12); color: #C08A00; }
    [data-theme="dark"] .status-pill.draft { background-color: rgba(239, 176, 52, 0.15); color: var(--color-warning); }

    /* ============================================
       SECTION HEADER
       ============================================ */
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
    .section-title { font-family: var(--font-heading); font-weight: 700; font-size: 16px; color: var(--text-primary); }

    .btn-add {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 8px 14px; border: none; border-radius: var(--radius-md);
      font-family: var(--font-body); font-size: 12px; font-weight: 600;
      cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      background-color: var(--color-primary); color: #FDF8F3; flex-shrink: 0;
    }
    .btn-add:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); background-color: var(--color-primary-hover); }
    [data-theme="dark"] .btn-add { background-color: var(--color-accent); color: #1A2A1F; }
    [data-theme="dark"] .btn-add:hover { background-color: var(--color-accent-hover); }
    .btn-add svg { width: 13px; height: 13px; }

    /* ============================================
       ACTIVITY CARDS
       ============================================ */
    .activity-list { display: flex; flex-direction: column; gap: 10px; }

    .activity-card {
      background-color: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden; position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .activity-card:hover { box-shadow: var(--shadow-sm); }
    .activity-card.expanded { box-shadow: var(--shadow-md); }

    .activity-row {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px 12px 8px;
      cursor: pointer; user-select: none; -webkit-user-select: none;
    }

    .activity-drag {
      width: 20px; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; cursor: grab; color: var(--text-secondary); opacity: 0.35;
      transition: opacity 0.2s ease; padding: 4px 0;
    }
    .activity-drag:hover { opacity: 0.7; }
    .activity-drag svg { width: 16px; height: 16px; }

    /* Type badge */
    .type-badge {
      width: 36px; height: 36px; border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; position: relative;
    }
    .type-badge svg { width: 18px; height: 18px; }

    .type-badge.mcq { background-color: rgba(45, 90, 61, 0.08); color: var(--color-primary); }
    [data-theme="dark"] .type-badge.mcq { background-color: rgba(61, 168, 99, 0.12); color: var(--color-success); }

    .type-badge.gap-fill { background-color: rgba(59, 122, 138, 0.08); color: var(--color-info); }
    [data-theme="dark"] .type-badge.gap-fill { background-color: rgba(77, 154, 174, 0.12); }

    .type-badge.matching { background-color: rgba(212, 168, 67, 0.08); color: #B8911F; }
    [data-theme="dark"] .type-badge.matching { background-color: rgba(212, 168, 67, 0.12); color: var(--color-accent); }

    .type-badge.listening { background-color: rgba(100, 80, 160, 0.08); color: #6450a0; }
    [data-theme="dark"] .type-badge.listening { background-color: rgba(140, 120, 200, 0.12); color: #b0a0e0; }

    .type-badge.flashcard { background-color: rgba(45, 138, 78, 0.08); color: var(--color-success); }
    [data-theme="dark"] .type-badge.flashcard { background-color: rgba(61, 168, 99, 0.10); }

    .type-badge.reading { background-color: rgba(180, 120, 60, 0.08); color: #9A6530; }
    [data-theme="dark"] .type-badge.reading { background-color: rgba(200, 150, 80, 0.12); color: #D4A860; }

    .type-badge.word-order { background-color: rgba(220, 69, 69, 0.06); color: #b33a3a; }
    [data-theme="dark"] .type-badge.word-order { background-color: rgba(232, 88, 88, 0.10); color: var(--color-error); }

    .type-label {
      position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%);
      font-size: 7px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.3px;
      white-space: nowrap; opacity: 0.7;
    }

    /* Activity info */
    .activity-info { flex: 1; min-width: 0; }
    .activity-question {
      font-size: 13px; font-weight: 600; color: var(--text-primary); line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .activity-preview { font-size: 11px; color: var(--text-secondary); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Expand chevron */
    .activity-expand {
      flex-shrink: 0; width: 26px; height: 26px;
      display: flex; align-items: center; justify-content: center;
      border-radius: var(--radius-sm); color: var(--text-secondary);
      transition: transform 0.3s ease, background-color 0.2s ease;
    }
    .activity-expand svg { width: 15px; height: 15px; }
    .activity-card.expanded .activity-expand { transform: rotate(180deg); }
    .activity-row:hover .activity-expand { background-color: rgba(45, 90, 61, 0.08); }
    [data-theme="dark"] .activity-row:hover .activity-expand { background-color: rgba(212, 168, 67, 0.1); }

    /* ============================================
       EXPANDED PANEL
       ============================================ */
    .activity-detail {
      border-top: 1px solid var(--border);
      max-height: 0; overflow: hidden; opacity: 0;
      transition: max-height 0.4s ease, opacity 0.3s ease;
    }
    .activity-card.expanded .activity-detail { max-height: 1200px; opacity: 1; }
    .activity-detail-inner { padding: 16px; }

    /* Form fields */
    .form-group { margin-bottom: 14px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-secondary); margin-bottom: 5px; }
    .form-input {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      font-family: var(--font-body); font-size: 14px; color: var(--text-primary);
      background-color: var(--bg-page);
      transition: border-color 0.2s ease, box-shadow 0.2s ease; outline: none;
    }
    .form-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(45, 90, 61, 0.1); }
    [data-theme="dark"] .form-input:focus { border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(212, 168, 67, 0.12); }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
    textarea.form-input { resize: vertical; min-height: 50px; line-height: 1.5; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* Type selector */
    .type-selector {
      display: flex; gap: 4px; flex-wrap: wrap;
    }
    .type-selector-btn {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 5px 10px; border: 1px solid var(--border); border-radius: var(--radius-sm);
      font-family: var(--font-body); font-size: 11px; font-weight: 600;
      cursor: pointer; background-color: transparent; color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .type-selector-btn:hover { border-color: var(--color-primary); color: var(--text-primary); }
    [data-theme="dark"] .type-selector-btn:hover { border-color: var(--color-accent); }
    .type-selector-btn.active { background-color: var(--color-primary); color: #FDF8F3; border-color: var(--color-primary); }
    [data-theme="dark"] .type-selector-btn.active { background-color: var(--color-accent); color: #1A2A1F; border-color: var(--color-accent); }
    .type-selector-btn svg { width: 12px; height: 12px; }

    /* MCQ options */
    .option-list { display: flex; flex-direction: column; gap: 8px; }
    .option-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background-color: var(--bg-page);
      transition: border-color 0.2s ease;
    }
    .option-item.correct { border-color: var(--color-success); background-color: rgba(45, 138, 78, 0.04); }
    [data-theme="dark"] .option-item.correct { background-color: rgba(61, 168, 99, 0.06); }

    .option-radio {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid var(--border); flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      transition: border-color 0.2s ease;
    }
    .option-item.correct .option-radio { border-color: var(--color-success); }
    .option-item.correct .option-radio::after {
      content: ''; width: 10px; height: 10px; border-radius: 50%;
      background-color: var(--color-success);
    }

    .option-input {
      flex: 1; border: none; background: transparent;
      font-family: var(--font-body); font-size: 14px; color: var(--text-primary);
      outline: none;
    }
    .option-input::placeholder { color: var(--text-secondary); opacity: 0.5; }

    .option-letter {
      font-size: 11px; font-weight: 700; color: var(--text-secondary);
      width: 18px; text-align: center; flex-shrink: 0;
    }
    .option-item.correct .option-letter { color: var(--color-success); }

    .btn-add-option {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 6px 10px; border: 1px dashed var(--border); border-radius: var(--radius-sm);
      font-family: var(--font-body); font-size: 12px; color: var(--text-secondary);
      cursor: pointer; background: transparent; transition: border-color 0.2s ease, color 0.2s ease;
      margin-top: 4px;
    }
    .btn-add-option:hover { border-color: var(--color-primary); color: var(--color-primary); }
    [data-theme="dark"] .btn-add-option:hover { border-color: var(--color-accent); color: var(--color-accent); }
    .btn-add-option svg { width: 12px; height: 12px; }

    /* Gap fill sentence */
    .gap-sentence {
      padding: 14px 16px;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background-color: var(--bg-page);
      font-size: 15px; line-height: 1.6; color: var(--text-primary);
    }
    .gap-blank {
      display: inline-block; min-width: 80px; border-bottom: 2px solid var(--color-accent);
      padding: 0 4px; margin: 0 2px; text-align: center;
      font-weight: 600; color: var(--color-accent);
    }

    /* Matching pairs */
    .match-pairs { display: flex; flex-direction: column; gap: 8px; }
    .match-pair {
      display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center;
    }
    .match-pair-input {
      padding: 10px 12px;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background-color: var(--bg-page);
      font-family: var(--font-body); font-size: 14px; color: var(--text-primary);
      outline: none; transition: border-color 0.2s ease;
    }
    .match-pair-input:focus { border-color: var(--color-primary); }
    [data-theme="dark"] .match-pair-input:focus { border-color: var(--color-accent); }
    .match-arrow { color: var(--text-secondary); opacity: 0.4; }
    .match-arrow svg { width: 16px; height: 16px; }

    /* Listening / audio ref */
    .audio-ref {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background-color: var(--bg-page);
    }
    .audio-play {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      background-color: var(--color-primary); color: #FDF8F3;
      flex-shrink: 0; cursor: pointer; transition: background-color 0.2s ease;
    }
    [data-theme="dark"] .audio-play { background-color: var(--color-accent); color: #1A2A1F; }
    .audio-play svg { width: 16px; height: 16px; margin-left: 2px; }
    .audio-info { flex: 1; }
    .audio-filename { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .audio-duration { font-size: 11px; color: var(--text-secondary); }

    /* Toggle */
    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
    .toggle-label-group { display: flex; flex-direction: column; }
    .toggle-label { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .toggle-hint { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }
    .toggle-switch { position: relative; width: 42px; height: 24px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
    .toggle-track { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); border-radius: 24px; cursor: pointer; transition: background-color 0.25s ease; }
    .toggle-track::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.15); transition: transform 0.25s ease; }
    .toggle-switch input:checked + .toggle-track { background-color: var(--color-success); }
    .toggle-switch input:checked + .toggle-track::after { transform: translateX(18px); }
    .toggle-switch input:focus-visible + .toggle-track { outline: 2px solid var(--color-primary); outline-offset: 2px; }
    [data-theme="dark"] .toggle-track { background-color: rgba(168, 181, 172, 0.25); }
    [data-theme="dark"] .toggle-track::after { background-color: var(--bg-page); }
    [data-theme="dark"] .toggle-switch input:checked + .toggle-track { background-color: var(--color-accent); }

    /* Actions */
    .activity-actions {
      display: flex; gap: 8px; margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--border);
    }
    .btn-save {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 10px 16px; border: none; border-radius: var(--radius-md);
      font-family: var(--font-body); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      background-color: var(--color-primary); color: #FDF8F3; flex: 1; justify-content: center;
    }
    .btn-save:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); background-color: var(--color-primary-hover); }
    [data-theme="dark"] .btn-save { background-color: var(--color-accent); color: #1A2A1F; }
    [data-theme="dark"] .btn-save:hover { background-color: var(--color-accent-hover); }
    .btn-save svg { width: 14px; height: 14px; }

    .btn-preview {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md);
      font-family: var(--font-body); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: border-color 0.2s ease, background-color 0.2s ease;
      background-color: transparent; color: var(--text-primary);
    }
    .btn-preview:hover { border-color: var(--color-primary); background-color: rgba(45, 90, 61, 0.04); }
    [data-theme="dark"] .btn-preview:hover { border-color: var(--color-accent); background-color: rgba(212, 168, 67, 0.06); }
    .btn-preview svg { width: 14px; height: 14px; }

    .btn-delete {
      display: inline-flex; align-items: center; justify-content: center;
      width: 40px; height: 40px; border: 1px solid var(--border); border-radius: var(--radius-md);
      cursor: pointer; transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
      background-color: transparent; color: var(--text-secondary); flex-shrink: 0;
    }
    .btn-delete:hover { border-color: var(--color-error); background-color: rgba(220, 69, 69, 0.06); color: var(--color-error); }
    .btn-delete svg { width: 15px; height: 15px; }

    /* ============================================
       MULTI-LANG CHIP ROW — compact language selector
       ============================================ */
    .chip-row { display: flex; align-items: center; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
    .chip-row-icon { font-size: 12px; opacity: 0.5; flex-shrink: 0; }

    .lang-chip {
      display: inline-flex; align-items: center; gap: 2px;
      padding: 2px 6px; border-radius: 10px;
      font-size: 9px; font-weight: 700; text-transform: uppercase;
      border: 1.5px solid var(--border); background-color: transparent;
      cursor: pointer; transition: all 0.2s ease; user-select: none;
      color: var(--text-secondary);
    }
    .lang-chip:hover { border-color: var(--text-primary); background-color: var(--bg-surface); }
    .lang-chip.active { border-width: 2px; }
    .lang-chip .chip-status { font-size: 7px; line-height: 1; }
    .lang-chip.filled .chip-status { opacity: 1; }
    .lang-chip.empty .chip-status { opacity: 0.4; }
    .lang-chip.auto .chip-status { opacity: 1; }

    .lang-chip-overflow {
      display: inline-flex; align-items: center;
      padding: 2px 6px; border-radius: 10px;
      font-size: 9px; font-weight: 600;
      border: 1.5px dashed var(--border); background-color: transparent;
      cursor: pointer; transition: all 0.2s ease; color: var(--text-secondary);
    }
    .lang-chip-overflow:hover { border-color: var(--text-primary); }

    .chip-expand-area { display: flex; flex-direction: column; gap: 3px; margin-top: 4px; }

    .chip-expand-row {
      display: flex; align-items: center; gap: 4px;
      padding: 4px 6px; border-radius: var(--radius-sm);
      background-color: var(--bg-surface); border: 1px solid var(--border);
      animation: fadeInUp 0.2s ease-out both; flex-wrap: wrap;
    }
    .chip-expand-row .lang-tag {
      display: inline-flex; align-items: center; justify-content: center;
      width: 24px; height: 24px; flex-shrink: 0;
      font-size: 9px; font-weight: 700; text-transform: uppercase;
      border-radius: var(--radius-xs); background-color: var(--bg-page);
      border: 1px solid var(--border); color: var(--text-secondary);
    }
    .chip-expand-row .form-input { flex: 1; min-width: 0; font-size: 13px; padding: 6px 8px; }
    .chip-expand-row .auto-badge {
      font-size: 9px; opacity: 0.7; flex-shrink: 0; padding: 1px 5px;
      border-radius: 8px; background-color: rgba(212, 168, 67, 0.15);
      color: var(--color-accent);
    }
    .chip-expand-row .btn-translate-all {
      font-size: 10px; padding: 3px 8px; margin: 0; border-width: 1px; flex-shrink: 0;
    }
    .chip-expand-close {
      background: none; border: none; cursor: pointer; padding: 2px;
      color: var(--text-secondary); font-size: 14px; line-height: 1;
      opacity: 0.5; transition: opacity 0.2s; flex-shrink: 0;
    }
    .chip-expand-close:hover { opacity: 1; color: var(--color-error); }

    .btn-translate-all {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 6px 12px; border-radius: var(--radius-sm);
      border: 1.5px dashed var(--color-accent); background-color: rgba(212, 168, 67, 0.06);
      color: var(--color-accent); font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s ease; margin-top: 6px;
      font-family: var(--font-body);
    }
    .btn-translate-all:hover { background-color: rgba(212, 168, 67, 0.15); border-style: solid; }

    /* Translate-all top bar inside expanded panel */
    .translate-all-bar {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 8px 12px; margin-bottom: 14px;
      border: 1.5px dashed var(--color-accent); border-radius: var(--radius-sm);
      background: rgba(212, 168, 67, 0.06);
      color: var(--color-accent); font-size: 12px; font-weight: 600;
      font-family: var(--font-body); cursor: pointer;
      transition: background 0.2s ease, border-style 0.2s ease;
    }
    .translate-all-bar:hover { background: rgba(212, 168, 67, 0.15); border-style: solid; }
    .translate-all-bar.translating { animation: pulse-strip 1s infinite; }
    @keyframes pulse-strip { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }


    /* Keep old classes for backwards compat */
    .lang-field-group { display: flex; flex-direction: column; gap: 4px; }
    .lang-field-row { display: flex; align-items: center; gap: 6px; }
    .lang-field-row .form-input { flex: 1; }
    .lang-tag {
      display: inline-flex; align-items: center; justify-content: center;
      width: 28px; height: 28px; flex-shrink: 0;
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      border-radius: var(--radius-xs); background-color: var(--bg-page);
      border: 1px solid var(--border); color: var(--text-secondary);
    }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    .anim { animation: fadeInUp 0.5s ease-out both; }
    .anim-d1 { animation-delay: 0.05s; }
    .anim-d2 { animation-delay: 0.10s; }
    .anim-d3 { animation-delay: 0.15s; }
    .anim-d4 { animation-delay: 0.20s; }
    .anim-d5 { animation-delay: 0.25s; }
    .anim-d6 { animation-delay: 0.30s; }
    .anim-d7 { animation-delay: 0.35s; }
    .anim-d8 { animation-delay: 0.40s; }

    @media (min-width: 768px) {
      .page-content { padding: 28px 24px 48px; }
      .lesson-header-name { font-size: 20px; }
      .lang-chip { padding: 3px 8px; font-size: 10px; gap: 3px; }
      .lang-chip .chip-status { font-size: 8px; }
      .chip-row { gap: 5px; }
      .chip-expand-row { padding: 6px 8px; gap: 6px; }
      .chip-expand-row .lang-tag { width: 28px; height: 28px; font-size: 10px; }
      .chip-expand-row .form-input { font-size: 14px; padding: 8px 10px; }
    }
    @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; } }
    body, .app-header, .activity-card, .lesson-header-card, .btn-add, .btn-save, .form-input { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header" id="app-header">
    <div class="app-header-inner">
      <div class="app-header-left">
        <a href="T1-teacher-dashboard.html" class="app-logo">
          <svg class="app-logo-sun" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="50.0,5.0 53.0,30.2 63.3,7.0 58.7,32.0 75.3,12.8 63.6,35.3 85.2,21.9 67.3,40.0 91.9,33.6 69.5,45.6 94.9,46.6 69.9,51.5 93.9,60.0 68.6,57.3 89.0,72.5 65.6,62.5 80.6,83.0 61.3,66.5 69.5,90.5 55.9,69.1 56.7,94.5 50.0,70.0 43.3,94.5 44.1,69.1 30.5,90.5 38.7,66.5 19.4,83.0 34.4,62.5 11.0,72.5 31.4,57.3 6.1,60.0 30.1,51.5 5.1,46.6 30.5,45.6 8.1,33.6 32.7,40.0 14.8,21.9 36.4,35.3 24.7,12.8 41.3,32.0 36.7,7.0 47.0,30.2" fill="#D4A843"/>
            <circle cx="50" cy="50" r="16" fill="#D4A843"/>
          </svg>
          <span class="app-logo-text">Hinbûna<br>Kurdî</span>
        </a>
      </div>
      <div class="header-actions">
        <button class="header-icon-btn" id="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
          <svg class="theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/><line x1="12" y1="2" x2="12" y2="0"/><line x1="4.93" y1="4.93" x2="3.51" y2="3.51"/><line x1="2" y1="12" x2="0" y2="12"/><line x1="22" y1="12" x2="24" y2="12"/><line x1="19.07" y1="4.93" x2="20.49" y2="3.51"/></svg>
          <svg class="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- PAGE CONTENT -->
  <main class="page-content" id="page-content">
    <!-- Breadcrumb (populated by JS) -->
    <nav class="breadcrumb anim anim-d1" aria-label="Breadcrumb" id="breadcrumb-nav"></nav>
    <!-- Lesson Info Card (populated by JS) -->
    <div class="lesson-header-card anim anim-d2" id="lesson-header-card"></div>
    <!-- Activities Section -->
    <div class="section-header anim anim-d3">
      <h2 class="section-title">Activities</h2>
      <button class="btn-add" onclick="return false;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Activity
      </button>
    </div>
    <div class="activity-list" id="activity-list"></div>
  </main>

  <!-- SCRIPTS -->
  <script src="shared/settings.js"></script>
  <script>
  (function () {
    'use strict';

    // --- Theme Toggle ---
    var html = document.documentElement;
    var saved = localStorage.getItem('hk-theme');
    if (saved) { if (saved === 'light') html.removeAttribute('data-theme'); else html.setAttribute('data-theme', saved); }
    else if (window.matchMedia('(prefers-color-scheme: dark)').matches) { html.setAttribute('data-theme', 'dark'); }
    var toggle = document.getElementById('theme-toggle');
    if (toggle) { toggle.addEventListener('click', function () { var current = html.getAttribute('data-theme'); var next = current === 'dark' ? 'light' : 'dark'; if (next === 'light') html.removeAttribute('data-theme'); else html.setAttribute('data-theme', 'dark'); localStorage.setItem('hk-theme', next); }); }
    var header = document.getElementById('app-header');
    if (header) { var scrolled = false; window.addEventListener('scroll', function () { var should = window.scrollY > 8; if (should !== scrolled) { scrolled = should; header.classList.toggle('scrolled', scrolled); } }, { passive: true }); }

    // ============================================================
    // SVG constants
    // ============================================================
    var SVG = {
      chevron: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>',
      expand: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
      drag: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="9" cy="6" r="1.5"/><circle cx="15" cy="6" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="9" cy="18" r="1.5"/><circle cx="15" cy="18" r="1.5"/></svg>',
      check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
      trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
      eye: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
      arrow: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
      plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>'
    };

    // Type badge SVGs
    var TYPE_SVG = {
      mcq: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
      gap_fill: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>',
      matching: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
      flashcard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="9" y1="12" x2="15" y2="12"/></svg>',
      reading: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
      listening: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>'
    };

    var TYPE_LABEL = { mcq: 'MCQ', gap_fill: 'GAP', matching: 'MATCH', flashcard: 'FLASH', reading: 'READ', listening: 'LISTEN' };
    var TYPE_CSS = { mcq: 'mcq', gap_fill: 'gap-fill', matching: 'matching', flashcard: 'flashcard', reading: 'reading', listening: 'listening' };
    var LETTERS = ['A', 'B', 'C', 'D', 'E', 'F'];

    // ============================================================
    // Multi-lang helpers — resolves { en: "...", de: "..." } objects
    // ============================================================
    var EDIT_LANGS = (window.HK && HK.LANGUAGES || []).filter(function (l) { return l.code !== 'ku'; });
    // Put 'de' first — it's the primary translation target
    EDIT_LANGS.sort(function (a, b) { return a.code === 'de' ? -1 : b.code === 'de' ? 1 : 0; });
    var CHIP_MAX_VISIBLE = 5;

    function t(val) {
      if (val == null) return '';
      if (typeof val === 'string') return val;
      if (typeof val === 'object') {
        if (val.en != null) return val.en;
        for (var k in val) { if (val.hasOwnProperty(k)) return val[k]; }
      }
      return String(val);
    }

    function tLang(val, code) {
      if (val == null) return '';
      if (typeof val === 'string') return code === 'en' ? val : '';
      if (typeof val === 'object' && val[code] != null) return val[code];
      return '';
    }

    // ============================================================
    // Helpers
    // ============================================================
    function el(tag, attrs, children) {
      var node = document.createElement(tag);
      if (attrs) for (var k in attrs) {
        if (k === 'className') node.className = attrs[k];
        else if (k === 'textContent') node.textContent = attrs[k];
        else if (k === 'checked' && attrs[k]) node.checked = true;
        else node.setAttribute(k, attrs[k]);
      }
      if (children) {
        if (typeof children === 'string') node.textContent = children;
        else if (Array.isArray(children)) children.forEach(function (c) { if (c) node.appendChild(c); });
        else node.appendChild(children);
      }
      return node;
    }

    function svgEl(str) {
      var w = document.createElement('span');
      w.insertAdjacentHTML('beforeend', str);
      return w.firstElementChild;
    }

    // ============================================================
    // URL params
    // ============================================================
    var params = new URLSearchParams(window.location.search);
    var paramUnit = params.get('unit');
    var paramLesson = params.get('lesson');

    // ============================================================
    // Breadcrumb
    // ============================================================
    function renderBreadcrumb(unitName, lessonName) {
      var nav = document.getElementById('breadcrumb-nav');
      if (!nav) return;
      var f = document.createDocumentFragment();
      f.appendChild(el('a', { href: 'T2-course-module.html', textContent: 'Content' }));
      f.appendChild(svgEl(SVG.chevron));
      f.appendChild(el('a', { href: 'T3-unit-editor.html', textContent: 'A1: Destpêk' }));
      f.appendChild(svgEl(SVG.chevron));
      f.appendChild(el('a', { href: 'T4-lesson-editor.html?unit=' + (paramUnit || '1'), textContent: unitName }));
      f.appendChild(svgEl(SVG.chevron));
      f.appendChild(el('span', { className: 'breadcrumb-current', textContent: lessonName }));
      nav.textContent = '';
      nav.appendChild(f);
    }

    // ============================================================
    // Lesson header card
    // ============================================================
    function renderLessonHeader(lesson, unitName, lessonIndex) {
      var card = document.getElementById('lesson-header-card');
      if (!card) return;
      var acts = lesson.activities || [];
      var types = {};
      acts.forEach(function (a) { types[a.type] = true; });
      var isPublished = lesson.isPublished !== false;

      var f = document.createDocumentFragment();

      var top = el('div', { className: 'lesson-header-top' });
      top.appendChild(el('div', { className: 'lesson-number-icon', textContent: 'L' + (lessonIndex + 1) }));
      var info = el('div', { className: 'lesson-header-info' });
      var subtitle = t((lesson.metadata && lesson.metadata.subtitle) || '');
      info.appendChild(el('h1', { className: 'lesson-header-name', textContent: lesson.name + (subtitle ? ' \u2014 ' + subtitle : '') }));
      info.appendChild(el('p', { className: 'lesson-header-path', textContent: 'Unit ' + (paramUnit || '?') + ': ' + unitName + ' \u00B7 A1: Destpêk' }));
      top.appendChild(info);
      top.appendChild(el('span', { className: 'status-pill ' + (isPublished ? 'published' : 'draft'), style: 'align-self:flex-start;margin-top:2px;', textContent: isPublished ? 'Published' : 'Draft' }));
      f.appendChild(top);

      if (lesson.learningObjective) {
        f.appendChild(el('div', { className: 'lesson-header-objective', textContent: t(lesson.learningObjective) }));
      }

      var stats = el('div', { className: 'lesson-header-stats' });
      function addStat(val, lbl) {
        var s = el('div', { className: 'lesson-stat' });
        s.appendChild(el('span', { className: 'lesson-stat-value', textContent: String(val) }));
        s.appendChild(el('span', { className: 'lesson-stat-label', textContent: lbl }));
        stats.appendChild(s);
      }
      function addDiv() { stats.appendChild(el('div', { className: 'lesson-stat-divider' })); }
      addStat(acts.length, 'Activities');
      addDiv();
      addStat(Object.keys(types).length, 'Types');
      addDiv();
      addStat(lesson.durationMinutes || 0, 'Minutes');
      f.appendChild(stats);

      card.textContent = '';
      card.appendChild(f);
    }

    // ============================================================
    // Get activity summary text for collapsed row
    // ============================================================
    function getActivityQuestion(act) {
      var c = act.content || {};
      switch (act.type) {
        case 'flashcard': return c.word ? c.word + ' \u2192 ' + t(c.translation || '') : t(act.instruction) || 'Flashcard';
        case 'reading': return t(c.title) || t(act.instruction) || 'Dialogue';
        case 'mcq': return t(act.instruction) || 'Multiple choice';
        case 'gap_fill': return c.display || t(act.instruction) || 'Gap fill';
        case 'matching': return t(act.instruction) || 'Match the pairs';
        case 'listening': return t(act.instruction) || 'Listening activity';
        default: return t(act.instruction) || act.type;
      }
    }

    function getActivityPreview(act) {
      var c = act.content || {};
      switch (act.type) {
        case 'flashcard': return c.example || 'Tap to learn';
        case 'reading': return (c.lines ? c.lines.length : 0) + ' lines \u00B7 ' + EDIT_LANGS.length + ' langs';
        case 'mcq': return (c.options ? c.options.length : 0) + ' options \u00B7 Correct: ' + LETTERS[c.correct || 0];
        case 'gap_fill': return 'Answer: ' + (c.gap || '?') + ' \u00B7 1 blank';
        case 'matching': return (c.pairs ? c.pairs.length : 0) + ' pairs \u00B7 ' + EDIT_LANGS.length + ' langs';
        case 'listening': return 'Audio \u00B7 ' + (c.options ? c.options.length : 0) + ' options';
        default: return act.type;
      }
    }

    // ============================================================
    // Build expanded edit form per activity type
    // ============================================================
    function buildEditForm(act) {
      var c = act.content || {};
      var inner = el('div', { className: 'activity-detail-inner' });

      // Instruction field (all types) — chip-row multi-lang
      addChipRowField(inner, 'Instruction', act.instruction, { kuField: false });

      // Type-specific fields
      switch (act.type) {
        case 'flashcard':
          addField(inner, 'Word (Kurdî)', c.word || '');
          addChipRowField(inner, 'Translation', c.translation, { kuField: false });
          addField(inner, 'Example Sentence (Kurdî)', c.example || '');
          addChipRowField(inner, 'Example Translation', c.exampleTranslation, { kuField: false });
          break;

        case 'reading':
          addChipRowField(inner, 'Dialogue Title', c.title, { kuField: false });
          if (c.lines && c.lines.length) {
            var linesGroup = el('div', { className: 'form-group' });
            linesGroup.appendChild(el('label', { className: 'form-label', textContent: 'Dialogue Lines' }));
            var pairs = el('div', { className: 'match-pairs' });
            c.lines.forEach(function (line) {
              var row = el('div', { className: 'match-pair', style: 'grid-template-columns: 60px 1fr;' });
              row.appendChild(el('input', { type: 'text', className: 'match-pair-input', value: line.speaker || '', placeholder: 'Speaker', style: 'text-align:center;font-weight:700;font-size:12px;' }));
              row.appendChild(el('input', { type: 'text', className: 'match-pair-input', value: line.ku || '', placeholder: 'Kurdî' }));
              pairs.appendChild(row);
              // Per-language chip-row translations
              var lineChipContainer = el('div', { style: 'margin-left:60px;' });
              addChipRowField(lineChipContainer, '', line, { kuField: false });
              pairs.appendChild(lineChipContainer);
            });
            linesGroup.appendChild(pairs);
            var addBtn = el('button', { className: 'btn-add-option', onclick: 'return false;' });
            addBtn.appendChild(svgEl(SVG.plus));
            addBtn.appendChild(document.createTextNode(' Add line'));
            linesGroup.appendChild(addBtn);
            inner.appendChild(linesGroup);
          }
          break;

        case 'mcq':
          if (c.options) {
            var optGroup = el('div', { className: 'form-group' });
            optGroup.appendChild(el('label', { className: 'form-label', textContent: 'Options (click radio to mark correct)' }));
            var optList = el('div', { className: 'option-list' });
            c.options.forEach(function (opt, idx) {
              var item = el('div', { className: 'option-item' + (idx === c.correct ? ' correct' : '') });
              item.appendChild(el('span', { className: 'option-letter', textContent: LETTERS[idx] }));
              item.appendChild(el('div', { className: 'option-radio' }));
              // Per-language chip-row option inputs
              var optChipContainer = el('div', { style: 'flex:1;' });
              addChipRowField(optChipContainer, '', opt, { kuField: false });
              item.appendChild(optChipContainer);
              optList.appendChild(item);
            });
            optGroup.appendChild(optList);
            var addOpt = el('button', { className: 'btn-add-option', onclick: 'return false;' });
            addOpt.appendChild(svgEl(SVG.plus));
            addOpt.appendChild(document.createTextNode(' Add option'));
            optGroup.appendChild(addOpt);
            inner.appendChild(optGroup);
          }
          if (c.explanation) addChipRowField(inner, 'Explanation', c.explanation, { kuField: false, textarea: true });
          break;

        case 'gap_fill':
          if (c.display) {
            var prevGroup = el('div', { className: 'form-group' });
            prevGroup.appendChild(el('label', { className: 'form-label', textContent: 'Preview' }));
            var gapSent = el('div', { className: 'gap-sentence' });
            gapSent.textContent = (c.before || '') + ' ';
            gapSent.appendChild(el('span', { className: 'gap-blank', textContent: c.gap || '___' }));
            gapSent.appendChild(document.createTextNode(' ' + (c.after || '')));
            prevGroup.appendChild(gapSent);
            inner.appendChild(prevGroup);
          }
          addField(inner, 'Correct Answer', c.gap || '');
          if (c.wordBank) addField(inner, 'Word Bank (comma-separated)', c.wordBank.join(', '));
          if (c.explanation) addChipRowField(inner, 'Explanation', c.explanation, { kuField: false, textarea: true });
          break;

        case 'matching':
          if (c.pairs) {
            var pairsGroup = el('div', { className: 'form-group' });
            pairsGroup.appendChild(el('label', { className: 'form-label', textContent: 'Matching Pairs' }));
            var pairsDiv = el('div', { className: 'match-pairs' });
            c.pairs.forEach(function (pair) {
              // Kurdish side
              var kuRow = el('div', { className: 'match-pair', style: 'grid-template-columns: 1fr auto 1fr;' });
              kuRow.appendChild(el('input', { type: 'text', className: 'match-pair-input', value: pair.ku || '', placeholder: 'Kurdî' }));
              var arrDiv = el('div', { className: 'match-arrow' });
              arrDiv.appendChild(svgEl(SVG.arrow));
              kuRow.appendChild(arrDiv);
              // Per-language chip-row translations on the right
              var pairChipContainer = el('div');
              addChipRowField(pairChipContainer, '', pair, { kuField: false });
              kuRow.appendChild(pairChipContainer);
              pairsDiv.appendChild(kuRow);
            });
            pairsGroup.appendChild(pairsDiv);
            var addPair = el('button', { className: 'btn-add-option', onclick: 'return false;' });
            addPair.appendChild(svgEl(SVG.plus));
            addPair.appendChild(document.createTextNode(' Add pair'));
            pairsGroup.appendChild(addPair);
            inner.appendChild(pairsGroup);
          }
          break;
      }

      // Translate all empty fields — top bar (first element in panel)
      var translateBar = el('div', { className: 'translate-all-bar' });
      translateBar.textContent = '\u2728 Translate all empty fields';
      translateBar.addEventListener('click', function () {
        translateBar.classList.add('translating');
        translateBar.textContent = '\u23F3 Translating all fields\u2026';
        var emptyChips = inner.querySelectorAll('.lang-chip.empty');
        var delay = 0;
        emptyChips.forEach(function (chip) {
          delay += 200;
          setTimeout(function () {
            chip.classList.remove('empty');
            chip.classList.add('auto');
            var st = chip.querySelector('.chip-status');
            if (st) st.textContent = '\u2728';
          }, delay);
        });
        setTimeout(function () {
          translateBar.classList.remove('translating');
          translateBar.textContent = '\u2728 Translate all empty fields';
        }, delay + 500);
      });
      inner.insertBefore(translateBar, inner.firstChild);

      // Published toggle (all types)
      var toggleGroup = el('div', { className: 'form-group' });
      var toggleRow = el('div', { className: 'toggle-row' });
      var labelG = el('div', { className: 'toggle-label-group' });
      labelG.appendChild(el('span', { className: 'toggle-label', textContent: 'Published' }));
      labelG.appendChild(el('span', { className: 'toggle-hint', textContent: 'Include in lesson' }));
      toggleRow.appendChild(labelG);
      var sw = el('label', { className: 'toggle-switch' });
      var cb = el('input', { type: 'checkbox' });
      if (act.isPublished !== false) cb.checked = true;
      sw.appendChild(cb);
      sw.appendChild(el('span', { className: 'toggle-track' }));
      toggleRow.appendChild(sw);
      toggleGroup.appendChild(toggleRow);
      inner.appendChild(toggleGroup);

      // Action buttons
      var actions = el('div', { className: 'activity-actions' });
      var saveBtn = el('button', { className: 'btn-save', onclick: 'return false;' });
      saveBtn.appendChild(svgEl(SVG.check));
      saveBtn.appendChild(document.createTextNode(' Save Activity'));
      actions.appendChild(saveBtn);
      var prevBtn = el('button', { className: 'btn-preview', onclick: 'return false;' });
      prevBtn.appendChild(svgEl(SVG.eye));
      prevBtn.appendChild(document.createTextNode(' Preview'));
      actions.appendChild(prevBtn);
      var delBtn = el('button', { className: 'btn-delete', onclick: 'return false;', title: 'Delete activity' });
      delBtn.appendChild(svgEl(SVG.trash));
      actions.appendChild(delBtn);
      inner.appendChild(actions);

      return inner;
    }

    function addField(parent, label, value) {
      var g = el('div', { className: 'form-group' });
      g.appendChild(el('label', { className: 'form-label', textContent: label }));
      g.appendChild(el('input', { type: 'text', className: 'form-input', value: value }));
      parent.appendChild(g);
    }

    function addTextarea(parent, label, value) {
      var g = el('div', { className: 'form-group' });
      g.appendChild(el('label', { className: 'form-label', textContent: label }));
      g.appendChild(el('textarea', { className: 'form-input', rows: '2', textContent: value }));
      parent.appendChild(g);
    }

    // ============================================================
    // Chip-row multi-lang field
    // ============================================================
    function addChipRowField(parent, label, value, opts) {
      opts = opts || {};
      var kuField = opts.kuField !== undefined ? opts.kuField : true;
      var kuValue = opts.kuValue || '';
      var useTextarea = opts.textarea || false;

      var g = el('div', { className: 'form-group' });
      if (label) {
        g.appendChild(el('label', { className: 'form-label', textContent: label }));
      }

      // Kurdish source input (if kuField is true)
      if (kuField) {
        if (useTextarea) {
          g.appendChild(el('textarea', { className: 'form-input', rows: '2', textContent: kuValue || (typeof value === 'string' ? value : (value && value.ku ? value.ku : '')), placeholder: 'Kurdî' }));
        } else {
          g.appendChild(el('input', { type: 'text', className: 'form-input', value: kuValue || (typeof value === 'string' ? value : (value && value.ku ? value.ku : '')), placeholder: 'Kurdî' }));
        }
      }

      // Chip row: globe icon + language chips
      var chipRow = el('div', { className: 'chip-row' });
      var globe = el('span', { className: 'chip-row-icon', textContent: '\uD83C\uDF10' });
      chipRow.appendChild(globe);

      // Expand area (below chip row)
      var expandArea = el('div', { className: 'chip-expand-area' });

      var visibleLangs = EDIT_LANGS.slice(0, CHIP_MAX_VISIBLE);
      var overflowLangs = EDIT_LANGS.slice(CHIP_MAX_VISIBLE);
      var allChips = [];

      function makeChip(lang, hidden) {
        var langVal = tLang(value, lang.code);
        var statusClass = langVal ? 'filled' : 'empty';
        var statusText = langVal ? '\u25CF' : '\u25CB';

        var chip = el('button', { className: 'lang-chip ' + statusClass });
        if (lang.color) {
          chip.style.borderColor = lang.color;
          chip.style.color = lang.color;
        }
        if (hidden) chip.style.display = 'none';
        chip.setAttribute('data-lang', lang.code);

        chip.appendChild(document.createTextNode(lang.code));
        var statusSpan = el('span', { className: 'chip-status', textContent: statusText });
        chip.appendChild(statusSpan);

        chip.addEventListener('click', function () {
          var existing = expandArea.querySelector('[data-expand-lang="' + lang.code + '"]');
          if (existing) {
            existing.remove();
            chip.classList.remove('active');
            return;
          }
          chip.classList.add('active');

          var expRow = el('div', { className: 'chip-expand-row' });
          expRow.setAttribute('data-expand-lang', lang.code);
          if (lang.dir === 'rtl') expRow.setAttribute('dir', 'rtl');

          var tag = el('span', { className: 'lang-tag', textContent: lang.code });
          if (lang.color) { tag.style.color = lang.color; tag.style.borderColor = lang.color; }
          expRow.appendChild(tag);

          var inputEl;
          if (useTextarea) {
            inputEl = el('textarea', { className: 'form-input', rows: '2', textContent: langVal, placeholder: lang.label + ' translation' });
          } else {
            inputEl = el('input', { type: 'text', className: 'form-input', value: langVal, placeholder: lang.label + ' translation' });
          }
          if (lang.dir === 'rtl') inputEl.setAttribute('dir', 'rtl');
          expRow.appendChild(inputEl);

          // Auto-badge if value was auto-translated
          if (chip.classList.contains('auto')) {
            expRow.appendChild(el('span', { className: 'auto-badge', textContent: '\u2728 auto' }));
          }

          // Auto-translate button for empty fields
          if (!langVal && !chip.classList.contains('auto')) {
            var autoBtn = el('button', { className: 'btn-translate-all' });
            autoBtn.textContent = '\u26A1 Auto-translate';
            autoBtn.addEventListener('click', function () {
              mockTranslate(expRow, lang.code, chip);
            });
            expRow.appendChild(autoBtn);
          }

          // Close button
          var closeBtn = el('button', { className: 'chip-expand-close', textContent: '\u2715' });
          closeBtn.addEventListener('click', function () {
            expRow.remove();
            chip.classList.remove('active');
          });
          expRow.appendChild(closeBtn);

          expandArea.appendChild(expRow);
          inputEl.focus();
        });

        allChips.push(chip);
        return chip;
      }

      visibleLangs.forEach(function (lang) {
        chipRow.appendChild(makeChip(lang, false));
      });

      // Overflow chips
      var overflowChipEls = [];
      if (overflowLangs.length > 0) {
        overflowLangs.forEach(function (lang) {
          var c = makeChip(lang, true);
          chipRow.appendChild(c);
          overflowChipEls.push(c);
        });

        var overflowBtn = el('button', { className: 'lang-chip-overflow', textContent: '+' + overflowLangs.length });
        overflowBtn.addEventListener('click', function () {
          overflowChipEls.forEach(function (c) { c.style.display = ''; });
          overflowBtn.style.display = 'none';
        });
        chipRow.appendChild(overflowBtn);
      }

      g.appendChild(chipRow);
      g.appendChild(expandArea);
      parent.appendChild(g);

      // Auto-open first chip (de) so it's always visible
      if (allChips.length > 0) allChips[0].click();
    }

    // Mock translate: simulates translation for empty fields
    function mockTranslate(expRow, targetCode, chipEl) {
      var autoBtn = expRow.querySelector('.btn-translate-all');
      if (autoBtn) autoBtn.textContent = '\u23F3 Translating...';

      setTimeout(function () {
        var inputEl = expRow.querySelector('.form-input');
        if (inputEl) {
          var placeholder = '[' + targetCode.toUpperCase() + ' translation \u2014 via DeepL]';
          if (inputEl.tagName === 'TEXTAREA') {
            inputEl.textContent = placeholder;
            inputEl.value = placeholder;
          } else {
            inputEl.value = placeholder;
          }
        }
        // Add auto badge
        if (autoBtn) autoBtn.remove();
        var badge = el('span', { className: 'auto-badge', textContent: '\u2728 auto' });
        var closeBtn = expRow.querySelector('.chip-expand-close');
        if (closeBtn) {
          expRow.insertBefore(badge, closeBtn);
        } else {
          expRow.appendChild(badge);
        }
        // Update chip status
        if (chipEl) {
          chipEl.classList.remove('empty');
          chipEl.classList.add('auto');
          var st = chipEl.querySelector('.chip-status');
          if (st) st.textContent = '\u2728';
        }
      }, 800);
    }

    // ============================================================
    // Build a single activity card
    // ============================================================
    function buildActivityCard(act, index, expandFirst) {
      var cardId = 'act-' + (index + 1);
      var type = act.type || 'mcq';
      var cssType = TYPE_CSS[type] || type;
      var animDelay = 'anim-d' + Math.min(index + 4, 8);
      var isPublished = act.isPublished !== false;
      var expanded = (expandFirst && index === 0) ? ' expanded' : '';

      var card = el('div', { className: 'activity-card' + expanded + ' anim ' + animDelay, id: cardId });

      // Collapsed row
      var row = el('div', { className: 'activity-row' });
      row.addEventListener('click', function () { card.classList.toggle('expanded'); });

      var dragDiv = el('div', { className: 'activity-drag', title: 'Drag to reorder' });
      dragDiv.appendChild(svgEl(SVG.drag));
      row.appendChild(dragDiv);

      var badge = el('div', { className: 'type-badge ' + cssType });
      badge.appendChild(svgEl(TYPE_SVG[type] || TYPE_SVG.mcq));
      badge.appendChild(el('span', { className: 'type-label', textContent: TYPE_LABEL[type] || type.toUpperCase() }));
      row.appendChild(badge);

      var info = el('div', { className: 'activity-info' });
      info.appendChild(el('div', { className: 'activity-question', textContent: getActivityQuestion(act) }));
      info.appendChild(el('div', { className: 'activity-preview', textContent: getActivityPreview(act) }));
      row.appendChild(info);

      row.appendChild(el('span', { className: 'status-pill ' + (isPublished ? 'published' : 'draft'), textContent: isPublished ? 'Published' : 'Draft' }));

      var expandDiv = el('div', { className: 'activity-expand' });
      expandDiv.appendChild(svgEl(SVG.expand));
      row.appendChild(expandDiv);

      card.appendChild(row);

      // Expanded edit panel
      var detail = el('div', { className: 'activity-detail' });
      detail.appendChild(buildEditForm(act));
      card.appendChild(detail);

      return card;
    }

    // ============================================================
    // Fetch data and render
    // ============================================================
    var unitId = paramUnit ? parseInt(paramUnit, 10) : 1;
    var lessonId = paramLesson || '1-1';

    Promise.all([
      fetch('data/unit-' + unitId + '.json').then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }),
      fetch('data/course.json').then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
    ])
    .then(function (results) {
      var unitData = results[0];
      var course = results[1];

      // Find the lesson
      var lesson = null;
      var lessonIndex = 0;
      for (var i = 0; i < unitData.lessons.length; i++) {
        if (unitData.lessons[i].id === lessonId) {
          lesson = unitData.lessons[i];
          lessonIndex = i;
          break;
        }
      }

      if (!lesson) {
        console.warn('Lesson "' + lessonId + '" not found, using first lesson.');
        lesson = unitData.lessons[0];
      }

      // Update page title
      var bcSubtitle = t((lesson.metadata && lesson.metadata.subtitle) || '');
      document.title = 'Activities \u2014 ' + lesson.name + ' \u2014 Hinb\u00FBna Kurd\u00EE';

      // Render breadcrumb
      renderBreadcrumb(unitData.name, lesson.name + (bcSubtitle ? ' \u2014 ' + bcSubtitle : ''));

      // Render lesson header
      renderLessonHeader(lesson, unitData.name, lessonIndex);

      // Render activity cards
      var list = document.getElementById('activity-list');
      if (list && lesson.activities) {
        var frag = document.createDocumentFragment();
        lesson.activities.forEach(function (act, idx) {
          frag.appendChild(buildActivityCard(act, idx, true));
        });
        list.appendChild(frag);
      }
    })
    .catch(function (err) {
      console.warn('T5: Could not load data.', err);
    });

  })();

  // Global toggle for backwards compat
  function toggleActivity(id) { var card = document.getElementById(id); if (card) card.classList.toggle('expanded'); }
  </script>
  <script src="shared/teacher-menu.js" data-active="content"></script>

</body>
</html>
