<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lesson Runner | Hinbuna Kurdî</title>
    <link rel="stylesheet" href="../../assets/site.css" />
    <style>
        .header {
            max-width: 1100px;
            margin: 24px auto 8px;
        }

        .crumbs {
            color: #666;
            font-size: 13px;
            margin-top: -6px;
        }

        .activities {
            max-width: 1100px;
            margin: 0 auto 32px;
            display: grid;
            gap: 16px;
        }

        .activity-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .activity-head {
            background: #f6f6f6;
            padding: 10px 14px;
            font-weight: 700;
        }

        .activity-body {
            padding: 14px;
        }

        .dialog .dialog-row {
            display: flex;
            gap: 10px;
            margin: 6px 0;
            align-items: flex-start;
        }

        .dialog .speaker {
            width: 88px;
            font-weight: 600;
            color: #444;
        }

        .dialog .bubble {
            flex: 1;
            border: 1px solid #eee;
            background: #fafafa;
            border-radius: 6px;
            padding: 10px;
        }

        .gap-quiz .prompt {
            margin-bottom: 8px;
            font-weight: 600;
        }

        .gap-quiz label {
            display: block;
            margin: 6px 0;
        }

        .verb-table table {
            border-collapse: collapse;
            width: 100%;
        }

        .verb-table td,
        .verb-table th {
            border: 1px solid #eee;
            padding: 8px;
        }

        .btn {
            display: inline-block;
            background: #000;
            color: #fff;
            border: 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        .btn:hover {
            background: #333
        }

        .back-link {
            max-width: 1100px;
            margin: 10px auto 24px;
        }

        .json-fallback {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            white-space: pre-wrap;
            font-size: 12px;
            background: #fafafa;
            border: 1px dashed #ddd;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div data-include="../../partials/header.html"></div>

    <div class="header">
        <h2 id="lesson-title">Loading…</h2>
        <div class="crumbs" id="crumbs"></div>
    </div>

    <div id="activities" class="activities" aria-live="polite"></div>

    <div class="back-link">
        <a id="backLink" href="../lessons/lesson.html">← Back to Lessons</a>
    </div>

    <div data-include="../../partials/footer.html"></div>
    <script src="../../assets/include.js"></script>
    <script>
        (async function () {
            // --- Query params from lessons page links
            const qs = new URLSearchParams(location.search);
            const book = qs.get('book') || 'a1-kurmanci';
            const unitId = qs.get('unit');   // e.g., UNIT:a1-kurmanci:u01
            const lesson = qs.get('lesson'); // e.g., LESSON:a1-kurmanci:u01:l01

            // --- Paths
            const ROOT = location.pathname.split('/modules/')[0] || '';
            const ORIGIN = location.origin;
            const url = (p) => `${ORIGIN}${ROOT}/assets/data/${p}`;

            // --- Helpers
            async function loadJSON(absUrl) {
                const res = await fetch(absUrl, { cache: 'no-cache' });
                if (!res.ok) throw new Error(`HTTP ${res.status} for ${absUrl}`);
                return res.json();
            }

            function lessonFileFromId(lessonId) {
                // LESSON:a1-kurmanci:u01:l01 -> lessons/u01-l01.json
                const parts = String(lessonId).split(':');
                const unitSlug = parts[parts.length - 2]; // u01
                const lessonCode = parts[parts.length - 1]; // l01
                return { unitSlug, lessonCode, file: `lessons/${unitSlug}-${lessonCode}.json` };
            }

            function activityIdToPath(activityId) {
                // Normalize: ACT:gap:ev-ew-01 -> activities/ACT_gap_ev_ew_01.json
                return `activities/${String(activityId).replace(/:/g, '_').replace(/-/g, '_')}.json`;
            }

            function niceLabel(type) {
                switch (type) {
                    case 'DIALOG': return 'Dialog';
                    case 'QUIZ_GAP':
                    case 'GAP': return 'Gap Quiz';
                    case 'VERB_TABLE': return 'Verb Table';
                    case 'TABLE': return 'Table';
                    default: return type || 'Activity';
                }
            }

            // --- Renderers
            function renderDialog(node, content) {
                const wrap = document.createElement('div');
                wrap.className = 'dialog';
                if (Array.isArray(content?.lines)) {
                    content.lines.forEach(line => {
                        const row = document.createElement('div');
                        row.className = 'dialog-row';
                        row.innerHTML = `
              <div class="speaker">${line.speaker || ''}</div>
              <div class="bubble">${line.text || ''}</div>
            `;
                        wrap.appendChild(row);
                    });
                } else {
                    const p = document.createElement('div');
                    p.className = 'bubble';
                    p.textContent = content?.text || '(No dialog content)';
                    wrap.appendChild(p);
                }
                node.appendChild(wrap);
            }

            function renderGap(node, content) {
                const box = document.createElement('div');
                box.className = 'gap-quiz';
                box.innerHTML = `
          <div class="prompt">${content?.prompt || ''}</div>
          ${(content?.choices || []).map((c, i) => `<label><input type="radio" name="gap"> ${c}</label>`).join('')}
          <div style="margin-top:8px"><button class="btn btn-check">Check</button></div>
        `;
                box.querySelector('.btn-check').onclick = () => {
                    alert('Answer: ' + (content?.answer ?? '—'));
                };
                node.appendChild(box);
            }

            function renderVerbTable(node, content) {
                const wrap = document.createElement('div');
                wrap.className = 'verb-table';

                if (content?.verb) {
                    const h = document.createElement('div');
                    h.style.fontWeight = '700';
                    h.style.marginBottom = '6px';
                    h.textContent = content.verb;
                    wrap.appendChild(h);
                }

                const tbl = document.createElement('table');
                (content?.rows || []).forEach((row) => {
                    const tr = document.createElement('tr');
                    (Array.isArray(row) ? row : [row]).forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbl.appendChild(tr);
                });
                wrap.appendChild(tbl);

                if (content?.mini_quiz?.q) {
                    const div = document.createElement('div');
                    div.style.marginTop = '8px';
                    div.innerHTML = `
            <div><strong>Mini-Quiz:</strong> ${content.mini_quiz.q}</div>
            <button class="btn btn-mini">Show answer</button>
          `;
                    div.querySelector('.btn-mini').onclick = () => alert(content.mini_quiz.answer || '—');
                    wrap.appendChild(div);
                }

                node.appendChild(wrap);
            }

            function renderTable(node, content) {
                const wrap = document.createElement('div');
                wrap.className = 'verb-table';
                const tbl = document.createElement('table');

                if (Array.isArray(content?.headers)) {
                    const tr = document.createElement('tr');
                    content.headers.forEach(h => {
                        const th = document.createElement('th');
                        th.textContent = h;
                        tr.appendChild(th);
                    });
                    tbl.appendChild(tr);
                }
                (content?.rows || []).forEach(r => {
                    const tr = document.createElement('tr');
                    r.forEach(c => {
                        const td = document.createElement('td');
                        td.textContent = c;
                        tr.appendChild(td);
                    });
                    tbl.appendChild(tr);
                });
                wrap.appendChild(tbl);
                node.appendChild(wrap);
            }

            function renderRaw(node, activity) {
                const pre = document.createElement('pre');
                pre.className = 'json-fallback';
                pre.textContent = JSON.stringify(activity, null, 2);
                node.appendChild(pre);
            }

            function renderActivity(body, activity) {
                switch (activity.type) {
                    case 'DIALOG': return renderDialog(body, activity.content);
                    case 'QUIZ_GAP':
                    case 'GAP': return renderGap(body, activity.content);
                    case 'VERB_TABLE': return renderVerbTable(body, activity.content);
                    case 'TABLE': return renderTable(body, activity.content);
                    default: return renderRaw(body, activity);
                }
            }

            // --- Load book label + lesson JSON
            try {
                const bookMeta = await loadJSON(url('book-a1.json')); // current book
                const { unitSlug, lessonCode, file } = lessonFileFromId(lesson);
                const lessonJson = await loadJSON(url(file));

                // Optional unit level in crumbs
                let unitLevel = '';
                try {
                    const unitJson = await loadJSON(url(`units/${unitSlug}.json`));
                    unitLevel = unitJson.level || '';
                } catch (e) { /* optional */ }

                // Header / crumbs
                const lessonTitle = lessonJson.title?.['ku-KMR'] || lessonJson.title?.ku ||
                    `Unit ${unitSlug.toUpperCase()} • Lesson ${lessonCode.toUpperCase()}`;
                document.getElementById('lesson-title').textContent = lessonTitle;

                const PROGRESS_KEY = "hk.progress.v1";
                const RECENTS_KEY = "hk.recentLessons.v1";

                function bumpProgress({ book, unitSlug, lessonCode, lessonTitle }) {
                    // update last, xp, streak (very naive demo)
                    const p = JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{"xp":0,"streak":0}');
                    p.xp = Number(p.xp || 0) + 10;
                    p.streak = Number(p.streak || 0); // add real streak logic later
                    p.last = {
                        book, unitSlug, lessonCode,
                        lessonId: `LESSON:${book}:${unitSlug}:${lessonCode}`
                    };
                    localStorage.setItem(PROGRESS_KEY, JSON.stringify(p));

                    // recent list
                    const recent = JSON.parse(localStorage.getItem(RECENTS_KEY) || "[]");
                    recent.unshift({
                        book, unitSlug, lessonCode,
                        lessonId: `LESSON:${book}:${unitSlug}:${lessonCode}`,
                        title: lessonTitle,
                        ts: Date.now()
                    });
                    localStorage.setItem(RECENTS_KEY, JSON.stringify(recent.slice(0, 20)));
                }

                const parts = [
                    bookMeta.title,
                    `Unit ${unitSlug.toUpperCase()}` + (unitLevel ? ` (Level ${unitLevel})` : ''),
                    `Lesson ${lessonCode.toUpperCase()}` + (lessonJson.level ? ` (Level ${lessonJson.level})` : '')
                ];
                document.getElementById('crumbs').textContent = parts.join(' · ');

                // Back link should preserve book so the lessons page knows which course
                document.getElementById('backLink').href = `../lessons/lesson.html?book=${encodeURIComponent(book)}`;

                // Render activities – PRACTICE ONLY
                const $activities = document.getElementById('activities');
                let refs = lessonJson.practice_refs || lessonJson.activity_refs || [];
                refs = refs.sort((a, b) => (a.order || 0) - (b.order || 0));

                for (const ref of refs) {
                    const path = activityIdToPath(ref.activity_id);
                    let activity;
                    try {
                        activity = await loadJSON(url(path));
                    } catch (e) {
                        activity = { type: 'ERROR', error: String(e), id: ref.activity_id };
                    }

                    const card = document.createElement('section');
                    card.className = 'activity-card';

                    const head = document.createElement('div');
                    head.className = 'activity-head';
                    head.textContent = niceLabel(activity.type || 'Unknown');
                    card.appendChild(head);

                    const body = document.createElement('div');
                    body.className = 'activity-body';
                    card.appendChild(body);

                    if (activity.type === 'ERROR') {
                        renderRaw(body, { message: 'Failed to load activity JSON', id: activity.id, error: activity.error, tried: url(path) });
                    } else {
                        renderActivity(body, activity);
                    }

                    $activities.appendChild(card);
                }

                // Optional: simple "More Practice" suggestion block
                const more = document.createElement('section');
                more.className = 'activity-card';
                more.innerHTML = `
          <div class="activity-head">More Practice</div>
          <div class="activity-body">
            <p>Want extra drills? Try these after finishing this lesson:</p>
            <ul class="more-list"></ul>
          </div>
        `;
                const pool = [
                    "ACT:gap:001", "ACT:gap:ev-ew-01", "ACT:gap:em-nan",
                    "ACT:test:letters:001", "ACT:svo:001", "ACT:riddle:001", "ACT:reading:sosin"
                ];
                const picks = pool.sort(() => Math.random() - 0.5).slice(0, 3);
                const ul = more.querySelector('.more-list');
                picks.forEach(id => {
                    const li = document.createElement('li');
                    li.textContent = id;
                    ul.appendChild(li);
                });
                $activities.appendChild(more);

            } catch (err) {
                console.error(err);
                const $activities = document.getElementById('activities');
                const card = document.createElement('section');
                card.className = 'activity-card';
                card.innerHTML = `
          <div class="activity-head">Error</div>
          <div class="activity-body">
            <div class="json-fallback">${String(err)}</div>
          </div>`;
                $activities.appendChild(card);
            }
        })();
    </script>
</body>

</html>