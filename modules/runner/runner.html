<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lesson Runner | Hinbuna Kurdî</title>
    <link rel="stylesheet" href="../../assets/site.css" />
    <style>
        .header {
            max-width: 1100px;
            margin: 24px auto 8px;
        }

        .crumbs {
            color: #666;
            font-size: 13px;
            margin-top: -6px;
        }

        .activities {
            max-width: 1100px;
            margin: 0 auto 32px;
            display: grid;
            gap: 16px;
        }

        .activity-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .activity-head {
            background: #f6f6f6;
            padding: 10px 14px;
            font-weight: 700;
        }

        .activity-body {
            padding: 14px;
        }

        .dialog .dialog-row {
            display: flex;
            gap: 10px;
            margin: 6px 0;
            align-items: flex-start;
        }

        .dialog .speaker {
            width: 88px;
            font-weight: 600;
            color: #444;
        }

        .dialog .bubble {
            flex: 1;
            border: 1px solid #eee;
            background: #fafafa;
            border-radius: 6px;
            padding: 10px;
        }

        .gap-quiz .prompt {
            margin-bottom: 8px;
            font-weight: 600;
        }

        .gap-quiz label {
            display: block;
            margin: 6px 0;
        }

        .verb-table table {
            border-collapse: collapse;
            width: 100%;
        }

        .verb-table td,
        .verb-table th {
            border: 1px solid #eee;
            padding: 8px;
        }

        .btn {
            display: inline-block;
            background: #000;
            color: #fff;
            border: 0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        .btn:hover {
            background: #333
        }

        .back-link {
            max-width: 1100px;
            margin: 10px auto 24px;
        }

        .json-fallback {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            white-space: pre-wrap;
            font-size: 12px;
            background: #fafafa;
            border: 1px dashed #ddd;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div data-include="../../partials/header.html"></div>

    <div class="header">
        <h2 id="lesson-title">Loading…</h2>
        <div class="crumbs" id="crumbs"></div>
    </div>

    <div id="activities" class="activities" aria-live="polite"></div>

    <div class="back-link">
        <a id="backLink" href="../lessons/lesson.html">← Back to Lessons</a>
    </div>

    <div data-include="../../partials/footer.html"></div>
    <script src="../../assets/include.js"></script>
    <script>
        (async function () {
            // --- Query params from lessons page links
            const qs = new URLSearchParams(location.search);
            const book = qs.get('book') || 'a1-kurmanci';
            const unit = qs.get('unit');   // e.g., UNIT:a1-kurmanci:u01
            const lesson = qs.get('lesson'); // e.g., LESSON:a1-kurmanci:u01:l01

            // --- Paths
            const ROOT = location.pathname.split('/modules/')[0] || '';
            const ORIGIN = location.origin;
            const url = (p) => `${ORIGIN}${ROOT}/assets/data/${p}`;

            // --- Helpers
            async function loadJSON(absUrl) {
                const res = await fetch(absUrl, { cache: 'no-cache' });
                if (!res.ok) throw new Error(`HTTP ${res.status} for ${absUrl}`);
                return res.json();
            }

            function lessonFileFromId(lessonId) {
                // LESSON:a1-kurmanci:u01:l01 -> lessons/u01-l01.json
                const parts = String(lessonId).split(':');
                const unitSlug = parts[parts.length - 2]; // u01
                const lessonCode = parts[parts.length - 1]; // l01
                return { unitSlug, lessonCode, file: `lessons/${unitSlug}-${lessonCode}.json` };
            }

            function activityIdToPath(activityId) {
                // ACT:dialog:001 -> activities/ACT_dialog_001.json
                return `activities/${String(activityId).replace(/:/g, '_')}.json`;
            }

            function niceLabel(type) {
                switch (type) {
                    case 'DIALOG': return 'Dialog';
                    case 'QUIZ_GAP':
                    case 'GAP': return 'Gap Quiz';
                    case 'VERB_TABLE': return 'Verb Table';
                    case 'TABLE': return 'Table';
                    default: return type || 'Activity';
                }
            }

            // --- Renderers
            function renderDialog(node, content) {
                const wrap = document.createElement('div');
                wrap.className = 'dialog';
                if (Array.isArray(content?.lines)) {
                    content.lines.forEach(line => {
                        const row = document.createElement('div');
                        row.className = 'dialog-row';
                        row.innerHTML = `
              <div class="speaker">${line.speaker || ''}</div>
              <div class="bubble">${line.text || ''}</div>
            `;
                        wrap.appendChild(row);
                    });
                } else {
                    const p = document.createElement('div');
                    p.className = 'bubble';
                    p.textContent = content?.text || '(No dialog content)';
                    wrap.appendChild(p);
                }
                node.appendChild(wrap);
            }

            function renderGap(node, content) {
                const box = document.createElement('div');
                box.className = 'gap-quiz';
                box.innerHTML = `
          <div class="prompt">${content?.prompt || ''}</div>
          ${(content?.choices || []).map((c, i) => `<label><input type="radio" name="gap"> ${c}</label>`).join('')}
          <div style="margin-top:8px">
            <button class="btn btn-check">Check</button>
          </div>
        `;
                box.querySelector('.btn-check').onclick = () => {
                    alert('Answer: ' + (content?.answer ?? '—'));
                };
                node.appendChild(box);
            }

            function renderVerbTable(node, content) {
                const wrap = document.createElement('div');
                wrap.className = 'verb-table';

                if (content?.verb) {
                    const h = document.createElement('div');
                    h.style.fontWeight = '700';
                    h.style.marginBottom = '6px';
                    h.textContent = content.verb;
                    wrap.appendChild(h);
                }

                const tbl = document.createElement('table');
                (content?.rows || []).forEach((row) => {
                    const tr = document.createElement('tr');
                    (Array.isArray(row) ? row : [row]).forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbl.appendChild(tr);
                });
                wrap.appendChild(tbl);

                if (content?.mini_quiz?.q) {
                    const div = document.createElement('div');
                    div.style.marginTop = '8px';
                    div.innerHTML = `
            <div><strong>Mini-Quiz:</strong> ${content.mini_quiz.q}</div>
            <button class="btn btn-mini">Show answer</button>
          `;
                    div.querySelector('.btn-mini').onclick = () => alert(content.mini_quiz.answer || '—');
                    wrap.appendChild(div);
                }

                node.appendChild(wrap);
            }

            function renderTable(node, content) {
                // Generic 2D table (for ACT_decl_ê_basic.json etc.)
                const wrap = document.createElement('div');
                wrap.className = 'verb-table';
                const tbl = document.createElement('table');

                if (Array.isArray(content?.headers)) {
                    const tr = document.createElement('tr');
                    content.headers.forEach(h => {
                        const th = document.createElement('th');
                        th.textContent = h;
                        tr.appendChild(th);
                    });
                    tbl.appendChild(tr);
                }
                (content?.rows || []).forEach(r => {
                    const tr = document.createElement('tr');
                    r.forEach(c => {
                        const td = document.createElement('td');
                        td.textContent = c;
                        tr.appendChild(td);
                    });
                    tbl.appendChild(tr);
                });
                wrap.appendChild(tbl);
                node.appendChild(wrap);
            }

            function renderRaw(node, activity) {
                const pre = document.createElement('pre');
                pre.className = 'json-fallback';
                pre.textContent = JSON.stringify(activity, null, 2);
                node.appendChild(pre);
            }

            function renderActivity(body, activity) {
                switch (activity.type) {
                    case 'DIALOG': return renderDialog(body, activity.content);
                    case 'QUIZ_GAP':
                    case 'GAP': return renderGap(body, activity.content);
                    case 'VERB_TABLE': return renderVerbTable(body, activity.content);
                    case 'TABLE': return renderTable(body, activity.content);
                    default: return renderRaw(body, activity);
                }
            }

            // --- Load book label + lesson JSON
            try {
                const bookMeta = await loadJSON(url('book-a1.json')); // map only A1 for now
                const { unitSlug, lessonCode, file } = lessonFileFromId(lesson);
                const lessonJson = await loadJSON(url(file));

                // Header / crumbs
                document.getElementById('lesson-title').textContent =
                    lessonJson.title?.['ku-KMR'] || lessonJson.title?.ku || `Unit ${unitSlug.toUpperCase()} • Lesson ${lessonCode.toUpperCase()}`;
                document.getElementById('crumbs').textContent =
                    `${bookMeta.title} · Unit ${unitSlug.toUpperCase()} · Lesson ${lessonCode.toUpperCase()}`;

                // Back link should preserve book so the lessons page knows which course
                document.getElementById('backLink').href = `../lessons/lesson.html?book=${encodeURIComponent(book)}`;

                // Render activities
                const $activities = document.getElementById('activities');
                const refs = (lessonJson.activity_refs || []).sort((a, b) => (a.order || 0) - (b.order || 0));

                for (const ref of refs) {
                    const path = activityIdToPath(ref.activity_id);
                    let activity;
                    try {
                        activity = await loadJSON(url(path));
                    } catch (e) {
                        activity = { type: 'ERROR', error: String(e), id: ref.activity_id };
                    }

                    const card = document.createElement('section');
                    card.className = 'activity-card';

                    const head = document.createElement('div');
                    head.className = 'activity-head';
                    head.textContent = niceLabel(activity.type || 'Unknown');
                    card.appendChild(head);

                    const body = document.createElement('div');
                    body.className = 'activity-body';
                    card.appendChild(body);

                    if (activity.type === 'ERROR') {
                        renderRaw(body, { message: 'Failed to load activity JSON', id: activity.id, error: activity.error, tried: url(path) });
                    } else {
                        renderActivity(body, activity);
                    }

                    $activities.appendChild(card);
                }
            } catch (err) {
                console.error(err);
                const $activities = document.getElementById('activities');
                const card = document.createElement('section');
                card.className = 'activity-card';
                card.innerHTML = `
          <div class="activity-head">Error</div>
          <div class="activity-body">
            <div class="json-fallback">${String(err)}</div>
          </div>`;
                $activities.appendChild(card);
            }
        })();
    </script>
</body>

</html>