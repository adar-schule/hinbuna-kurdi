<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher Dashboard | Hinbuna KurdÃ®</title>
    <link rel="stylesheet" href="../../assets/site.css" />
    <style>
        .wrap {
            width: min(1600px, 96vw);
            margin: 24px auto;
            padding: 0 clamp(8px, 2vw, 24px)
        }

        .hello {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
            justify-content: space-between
        }

        .hello h2 {
            margin: 0
        }

        /* KPI row: horizontal cards that wrap when needed */
        .kpis {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 8px 0 18px;
        }

        .chip {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1 1 220px;
            /* horizontal by default, wraps on small screens */
            min-width: 220px;
        }

        .chip strong {
            font-size: 14px
        }

        .chip .value {
            font-weight: 700;
            font-variant-numeric: tabular-nums
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(clamp(260px, 30vw, 520px), 1fr));
            gap: clamp(10px, 1.5vw, 20px);
        }

        .card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden
        }

        .card-hd {
            padding: 12px 14px;
            background: #f6f6f6;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .card-bd {
            padding: 14px
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .btn {
            display: inline-block;
            background: #000;
            color: #fff;
            border: 0;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none
        }

        .btn:hover {
            background: #333
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px
        }

        .item h4 {
            margin: 0 0 2px;
            font-size: 15px
        }

        .meta {
            font-size: 12px;
            color: #666
        }

        .badge {
            display: inline-block;
            background: #efefef;
            border: 1px solid #ddd;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            margin-left: 8px
        }

        /* Mobile niceties */
        @media (max-width: 720px) {
            .item {
                flex-direction: column;
                align-items: stretch
            }

            .item .btn {
                width: 100%;
                text-align: center
            }

            .card-bd .row .btn {
                width: auto
            }
        }

        /* Wider screens: slightly denser */
        @media (min-width:1600px) {
            .wrap {
                width: min(1800px, 96vw)
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr))
            }
        }
    </style>
</head>

<body>
    <div data-include="../../partials/header.html"></div>

    <main class="wrap" aria-live="polite">
        <div class="hello">
            <h2>Teacher Dashboard</h2>
        </div>

        <!-- KPI SUMMARY (horizontal) -->
        <section class="kpis">
            <div class="chip"><strong>ðŸ‘¥ Users</strong><span class="value" id="kpiUsers">0</span></div>
            <div class="chip"><strong>ðŸ”¥ Avg Streak</strong><span class="value" id="kpiStreak">0</span></div>
            <div class="chip"><strong>ðŸ“¦ Materials</strong><span class="value" id="kpiMaterials">0</span></div>
            <div class="chip"><strong>ðŸ’¬ Unread</strong><span class="value" id="kpiUnread">0</span></div>
        </section>

        <section class="grid">
            <!-- USERS & PROGRESS -->
            <article class="card">
                <div class="card-hd">
                    <span>Users &amp; Progress</span>
                    <a class="btn" href="users.html">Manage â†’</a>
                </div>
                <div class="card-bd">
                    <div id="usersList" class="list"></div>
                </div>
            </article>

            <!-- RECENT SUBMISSIONS -->
            <article class="card">
                <div class="card-hd">
                    <span>Recent Submissions</span>
                    <a class="btn" href="analytics.html#submissions">See all â†’</a>
                </div>
                <div class="card-bd">
                    <div id="subList" class="list"></div>
                </div>
            </article>

            <!-- MATERIALS -->
            <article class="card">
                <div class="card-hd">
                    <span>Materials</span>
                    <div class="row">
                        <a class="btn" href="builder.html">Add New</a>
                        <a class="btn" href="materials.html">All Materials â†’</a>
                    </div>
                </div>
                <div class="card-bd">
                    <div id="materialsList" class="list"></div>
                </div>
            </article>

            <!-- ANNOUNCEMENTS & MESSAGES -->
            <article class="card">
                <div class="card-hd">
                    <span>Announcements &amp; Messages</span>
                    <div class="row">
                        <a class="btn" href="announcements.html">Announcements â†’</a>
                        <a class="btn" href="messages.html">Messages â†’</a>
                    </div>
                </div>
                <div class="card-bd">
                    <div id="annList" class="list" style="margin-bottom:12px;"></div>
                    <div id="msgList" class="list"></div>
                </div>
            </article>

            <!-- ANALYTICS -->
            <article class="card">
                <div class="card-hd">
                    <span>Analytics</span>
                    <a class="btn" href="analytics.html">Open â†’</a>
                </div>
                <div class="card-bd">
                    <div class="meta">Overview of XP, streaks, and completion per unit/lesson.</div>
                </div>
            </article>
        </section>
    </main>

    <div data-include="../../partials/footer.html"></div>
    <script src="../../assets/include.js"></script>
    <script>
        (function () {
            // Local storage keys
            const USERS_KEY = "hk.teacher.users.v1";         // [ { uid, name, email, xp, streak, last:{ book, unitSlug, lessonCode } } ]
            const MATS_KEY = "hk.teacher.materials.v1";     // [ { id, kind:'lesson|set|doc', title, ref:{ book, unitSlug, lessonCode, activityRefs? }, createdAt } ]
            const ANNS_KEY = "hk.teacher.announcements.v1"; // { global: [ { id, title, body, createdAt } ] }
            const MSGS_KEY = "hk.teacher.messages.v1";      // [ { id, from, to, body, createdAt, read } ]
            const SBMS_KEY = "hk.teacher.submissions.v1";   // [ { assignmentId, uid, submittedAt, score } ]

            const $ = id => document.getElementById(id);
            const read = (k, f) => { try { return JSON.parse(localStorage.getItem(k)) || f; } catch { return f; } };
            const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
            const fmt = ts => { try { return new Date(ts).toLocaleString(); } catch { return String(ts); } };

            // Seed demo data (only if empty)
            function seedIfEmpty() {
                if (!read(USERS_KEY, []).length) {
                    write(USERS_KEY, [
                        { uid: "STU:001", name: "Nalin", email: "nalin@example.com", xp: 420, streak: 3, last: { book: "a1-kurmanci", unitSlug: "u01", lessonCode: "l01" } },
                        { uid: "STU:002", name: "Baran", email: "baran@example.com", xp: 680, streak: 5, last: { book: "a1-kurmanci", unitSlug: "u02", lessonCode: "l01" } },
                        { uid: "STU:003", name: "Sipan", email: "sipan@example.com", xp: 120, streak: 1, last: { book: "a1-kurmanci", unitSlug: "u01", lessonCode: "l01" } }
                    ]);
                }
                if (!read(MATS_KEY, []).length) {
                    write(MATS_KEY, [
                        { id: "MAT:001", kind: "lesson", title: "u01 â€¢ l01 Practice", ref: { book: "a1-kurmanci", unitSlug: "u01", lessonCode: "l01" }, createdAt: Date.now() - 86400000 * 5 },
                        { id: "MAT:002", kind: "set", title: "Alphabet quick test", ref: { book: "a1-kurmanci", unitSlug: "u06", lessonCode: "l01", activityRefs: ["ACT:test:letters:001", "ACT:svo:001"] }, createdAt: Date.now() - 86400000 * 2 }
                    ]);
                }
                const anns = read(ANNS_KEY, {});
                if (!anns.global) {
                    anns.global = [{ id: "AN:001", title: "Welcome to the course", body: "Check A1 Unit 1 before Friday.", createdAt: Date.now() - 86400000 * 3 }];
                    write(ANNS_KEY, anns);
                }
                if (!read(MSGS_KEY, []).length) {
                    write(MSGS_KEY, [
                        { id: "MSG:001", from: "STU:001", to: "TEACHER", body: "Can I get extra practice for vowels?", createdAt: Date.now() - 86400000, read: false },
                        { id: "MSG:002", from: "STU:002", to: "TEACHER", body: "I will miss Thursday.", createdAt: Date.now() - 86400000 * 2, read: true }
                    ]);
                }
                if (!read(SBMS_KEY, []).length) {
                    write(SBMS_KEY, [
                        { assignmentId: "AS:001", uid: "STU:001", submittedAt: Date.now() - 86400000 * 1, score: 86 },
                        { assignmentId: "AS:001", uid: "STU:002", submittedAt: Date.now() - 86400000 * 2, score: 92 }
                    ]);
                }
            }

            function renderKPIs(users, mats, msgs) {
                const avgStreak = users.length ? Math.round(users.reduce((s, u) => s + (Number(u.streak) || 0), 0) / users.length) : 0;
                const unread = msgs.filter(m => !m.read).length;
                $("kpiUsers").textContent = String(users.length);
                $("kpiStreak").textContent = String(avgStreak);
                $("kpiMaterials").textContent = String(mats.length);
                $("kpiUnread").textContent = String(unread);
            }

            function renderUsers(users) {
                const box = $("usersList"); if (!box) return; box.innerHTML = "";
                users.slice().sort((a, b) => (b.xp || 0) - (a.xp || 0)).slice(0, 6).forEach(u => {
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
            <div>
              <h4>${u.name} <span class="badge">ðŸ”¥ ${u.streak} â€¢ XP ${u.xp}</span></h4>
              <div class="meta">${u.email} â€¢ Last: ${u.last?.book} Â· ${String(u.last?.unitSlug || '').toUpperCase()} Â· ${String(u.last?.lessonCode || '').toUpperCase()}</div>
            </div>
            <a class="btn" href="user-detail.html?uid=${encodeURIComponent(u.uid)}">Open â†’</a>
          `;
                    box.appendChild(div);
                });
                if (!users.length) box.innerHTML = `<div class="meta">No users yet.</div>`;
            }

            function renderMaterials(mats) {
                const box = $("materialsList"); if (!box) return; box.innerHTML = "";
                mats.slice().sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 6).forEach(m => {
                    const ref = m.ref || {};
                    const refText = ref.activityRefs ? `${ref.activityRefs.length} activities` :
                        `${String(ref.unitSlug || '').toUpperCase()} â€¢ ${String(ref.lessonCode || '').toUpperCase()}`;
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
            <div>
              <h4>${m.title} <span class="badge">${m.kind}</span></h4>
              <div class="meta">${ref.book || 'a1-kurmanci'} â€¢ ${refText} â€¢ ${fmt(m.createdAt)}</div>
            </div>
            <a class="btn" href="material-detail.html?id=${encodeURIComponent(m.id)}">Open â†’</a>
          `;
                    box.appendChild(div);
                });
                if (!mats.length) box.innerHTML = `<div class="meta">No materials yet. Click "Add New".</div>`;
            }

            function renderAnnouncements(anns) {
                const box = $("annList"); if (!box) return; box.innerHTML = "";
                const list = (anns && anns.global) ? anns.global : [];
                list.slice().sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 3).forEach(a => {
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
            <div>
              <h4>${a.title}</h4>
              <div class="meta">${fmt(a.createdAt)}</div>
            </div>
            <a class="btn" href="announcements.html#${a.id}">View â†’</a>
          `;
                    box.appendChild(div);
                });
                if (!list.length) box.innerHTML = `<div class="meta">No announcements yet.</div>`;
            }

            function renderMessages(msgs) {
                const box = $("msgList"); if (!box) return; box.innerHTML = "";
                msgs.slice().sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 4).forEach(m => {
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
            <div>
              <h4>${m.from} ${m.read ? '' : '<span class="badge">unread</span>'}</h4>
              <div class="meta">${fmt(m.createdAt)} â€¢ ${m.body}</div>
            </div>
            <a class="btn" href="messages.html#${m.id}">Open â†’</a>
          `;
                    box.appendChild(div);
                });
                if (!msgs.length) box.innerHTML = `<div class="meta">No messages.</div>`;
            }

            function renderSubmissions(subs) {
                const box = $("subList"); if (!box) return; box.innerHTML = "";
                subs.slice().sort((a, b) => (b.submittedAt || 0) - (a.submittedAt || 0)).slice(0, 6).forEach(s => {
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `
            <div>
              <h4>${s.uid} <span class="badge">Score ${typeof s.score === 'number' ? s.score : 'â€”'}</span></h4>
              <div class="meta">Assignment ${s.assignmentId} â€¢ ${fmt(s.submittedAt)}</div>
            </div>
            <a class="btn" href="assignment-detail.html?assignmentId=${encodeURIComponent(s.assignmentId)}">Open â†’</a>
          `;
                    box.appendChild(div);
                });
                if (!subs.length) box.innerHTML = `<div class="meta">No submissions yet.</div>`;
            }

            // boot
            seedIfEmpty();
            const users = read(USERS_KEY, []);
            const mats = read(MATS_KEY, []);
            const anns = read(ANNS_KEY, { global: [] });
            const msgs = read(MSGS_KEY, []);
            const subs = read(SBMS_KEY, []);

            renderKPIs(users, mats, msgs);
            renderUsers(users);
            renderMaterials(mats);
            renderAnnouncements(anns);
            renderMessages(msgs);
            renderSubmissions(subs);
        })();
    </script>
</body>

</html>