<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Model — Hinbûna Kurdî</title>
  <meta name="description" content="Interactive data model explorer for Hinbuna Kurdi. 46 tables across 12 domains.">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='none'/%3E%3Cpolygon points='50.0,5.0 53.0,30.2 63.3,7.0 58.7,32.0 75.3,12.8 63.6,35.3 85.2,21.9 67.3,40.0 91.9,33.6 69.5,45.6 94.9,46.6 69.9,51.5 93.9,60.0 68.6,57.3 89.0,72.5 65.6,62.5 80.6,83.0 61.3,66.5 69.5,90.5 55.9,69.1 56.7,94.5 50.0,70.0 43.3,94.5 44.1,69.1 30.5,90.5 38.7,66.5 19.4,83.0 34.4,62.5 11.0,72.5 31.4,57.3 6.1,60.0 30.1,51.5 5.1,46.6 30.5,45.6 8.1,33.6 32.7,40.0 14.8,21.9 36.4,35.3 24.7,12.8 41.3,32.0 36.7,7.0 47.0,30.2' fill='%23D4A843'/%3E%3Ccircle cx='50' cy='50' r='16' fill='%23D4A843'/%3E%3C/svg%3E">
  <link rel="stylesheet" href="shared/fonts.css">
  <script src="shared/ecosystem-apps.js"></script>
  <script src="shared/theme.js"></script>
  <link rel="stylesheet" href="shared/header.css">
  <link rel="stylesheet" href="shared/footer.css">
  <link rel="stylesheet" href="shared/settings.css">

  <style>
    :root {
      --bg-page: #FDF8F3; --bg-surface: #F5EEE6; --bg-surface-alt: #EDE5DA;
      --color-primary: #2D5A3D; --color-accent: #D4A843; --color-tan: #E3C79D;
      --text-primary: #1A2A1F; --text-secondary: #5A6B5E; --border: #E5DDD3;
      --color-success: #2D8A4E; --color-error: #DC4545; --color-warning: #EFB034; --color-info: #3B7A8A;
      --shadow-sm: 0 1px 3px rgba(26,42,31,0.06); --shadow-md: 0 4px 12px rgba(26,42,31,0.08);
      --font-heading: 'Nunito', sans-serif; --font-body: 'Inter', sans-serif;
      --radius-xs: 4px; --radius-sm: 8px; --radius-md: 12px;
    }
    [data-theme="dark"] {
      --bg-page: #1A2024; --bg-surface: #232D31; --bg-surface-alt: #2A363B;
      --color-accent: #D4A843; --color-tan: #3A4E56;
      --text-primary: #F5EEE6; --text-secondary: #9CADA8; --border: #2F3B3E;
      --color-success: #3DA863; --color-error: #E85858; --color-info: #4D9AAE;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.2); --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-body); font-size: 15px; line-height: 1.6; color: var(--text-primary); background: var(--bg-page); min-height: 100vh; transition: background-color 0.3s, color 0.3s; }
    a { text-decoration: none; color: inherit; }

    .dm-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    @media (min-width: 768px) { .dm-container { padding: 0 40px; } }

    .dm-intro { padding: 16px 0 8px; text-align: center; }
    .dm-intro h1 { font-family: var(--font-heading); font-weight: 800; font-size: 20px; margin-bottom: 2px; }
    .dm-intro p { font-size: 12px; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }
    .stats { display: flex; justify-content: center; gap: 20px; margin-top: 6px; }
    .stat-num { font-family: var(--font-heading); font-weight: 800; font-size: 20px; color: var(--color-accent); }
    .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
    @media (min-width: 768px) { .dm-intro { padding: 24px 0 12px; } .dm-intro h1 { font-size: 26px; } .stat-num { font-size: 24px; } }

    .badge { display: inline-flex; align-items: center; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 20px; white-space: nowrap; letter-spacing: 0.03em; text-transform: uppercase; }
    .badge-core { background: rgba(45,138,78,0.1); color: #2D8A4E; }
    .badge-optional { background: rgba(90,107,94,0.1); color: #5A6B5E; }
    .badge-pk { background: rgba(212,168,67,0.15); color: #D4A843; }
    .badge-fk { background: rgba(59,122,138,0.12); color: #3B7A8A; }
    .badge-uk { background: rgba(139,92,246,0.1); color: #8B5CF6; }
    .badge-json { background: rgba(212,168,67,0.1); color: #D4A843; }
    [data-theme="dark"] .badge-core { background: rgba(61,168,99,0.15); color: #3DA863; }
    [data-theme="dark"] .badge-optional { background: rgba(168,181,172,0.1); color: #9CADA8; }
    [data-theme="dark"] .badge-fk { background: rgba(77,154,174,0.15); color: #4D9AAE; }
    [data-theme="dark"] .badge-uk { background: rgba(139,92,246,0.15); color: #A78BFA; }

    .domain-grid { display: grid; grid-template-columns: 1fr; gap: 6px; margin-bottom: 16px; }
    @media (min-width: 550px) { .domain-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 850px) { .domain-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1050px) { .domain-grid { grid-template-columns: repeat(4, 1fr); } }

    .domain-card { display: flex; align-items: center; gap: 8px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 14px; cursor: pointer; user-select: none; transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s; }
    .domain-card:hover { border-color: var(--color-accent); box-shadow: var(--shadow-sm); }
    .domain-card.active { border-color: var(--color-accent); background: var(--bg-surface-alt); }
    .d-name { font-family: var(--font-heading); font-weight: 700; font-size: 13px; }
    .d-count { font-family: var(--font-heading); font-weight: 800; font-size: 16px; color: var(--color-accent); margin-left: auto; }
    .d-chevron { width: 14px; height: 14px; color: var(--text-secondary); transition: transform 0.2s; flex-shrink: 0; }
    .domain-card.active .d-chevron { transform: rotate(180deg); color: var(--color-accent); }

    .domain-detail { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 16px; overflow: hidden; }
    .domain-detail-header { padding: 16px 20px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .domain-detail-header h2 { font-family: var(--font-heading); font-weight: 800; font-size: 18px; flex: 1; }

    .table-row { display: flex; align-items: center; gap: 10px; padding: 10px 20px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background-color 0.15s; }
    .table-row:last-child { border-bottom: none; }
    .table-row:hover, .table-row.active { background: var(--bg-surface-alt); }
    .t-name { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; font-weight: 600; color: var(--color-accent); white-space: nowrap; }
    .t-desc { font-size: 13px; color: var(--text-secondary); flex: 1; }
    .t-cols { font-size: 11px; color: var(--text-secondary); white-space: nowrap; }
    .t-chevron { width: 14px; height: 14px; color: var(--text-secondary); transition: transform 0.2s; flex-shrink: 0; }
    .table-row.active .t-chevron { transform: rotate(180deg); color: var(--color-accent); }

    .schema-panel { background: var(--bg-page); border-top: 1px solid var(--border); padding: 16px 20px; }
    .schema-grid { display: grid; grid-template-columns: auto 1fr auto; gap: 4px 16px; font-size: 13px; }
    .col-name { font-family: 'SF Mono', 'Fira Code', monospace; font-weight: 600; padding: 3px 0; }
    .col-type { font-family: 'SF Mono', 'Fira Code', monospace; color: var(--color-success); padding: 3px 0; }
    .col-notes { color: var(--text-secondary); font-size: 12px; padding: 3px 0; text-align: right; }
    .rels { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .rels-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
    .rel-item { font-size: 12px; color: var(--text-secondary); padding: 2px 0; cursor: pointer; }
    .rel-item:hover { color: var(--color-accent); }
    .rel-item code { font-family: 'SF Mono', 'Fira Code', monospace; color: var(--color-info); background: var(--bg-surface); padding: 1px 4px; border-radius: 3px; font-size: 12px; }

    /* ERD Diagram */
    .erd-section { margin-bottom: 12px; }
    .erd-wrap { position: relative; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
    .erd-toolbar { display: flex; align-items: center; justify-content: flex-end; gap: 4px; padding: 6px 12px; border-bottom: 1px solid var(--border); background: var(--bg-surface-alt); }
    .erd-toolbar button { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-xs); color: var(--text-secondary); width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: border-color 0.2s, color 0.2s; }
    .erd-toolbar button:hover { border-color: var(--color-accent); color: var(--color-accent); }
    .erd-toolbar .erd-label { font-size: 11px; color: var(--text-secondary); margin-right: auto; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
    .erd-viewport { overflow: hidden; height: 40vh; min-height: 180px; max-height: 400px; }
    .erd-viewport svg { max-width: none !important; cursor: grab; }
    .erd-viewport svg:active { cursor: grabbing; }
    .erd-wrap.fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; border-radius: 0; border: none; }
    .erd-wrap.fullscreen .erd-viewport { height: calc(100vh - 44px); }

    .source-link { text-align: center; padding: 24px 0 48px; font-size: 13px; color: var(--text-secondary); }
    .source-link a { color: var(--color-accent); text-decoration: underline; text-underline-offset: 2px; }
  </style>
</head>
<body>

  <div id="shared-header" data-page-type="data-model"></div>

  <main class="dm-container">
    <section class="dm-intro">
      <h1>Data Model</h1>
      <p>Click a domain to explore its tables. Click a table to see its schema.</p>
      <div class="stats">
        <div class="stat"><div class="stat-num" id="total-tables">46</div><div class="stat-label">Tables</div></div>
        <div class="stat"><div class="stat-num" id="total-domains">12</div><div class="stat-label">Domains</div></div>
        <div class="stat"><div class="stat-num" id="total-columns">0</div><div class="stat-label">Columns</div></div>
      </div>
    </section>

    <!-- ERD Diagram -->
    <section class="erd-section">
      <div class="erd-wrap" id="erd-wrap">
        <div class="erd-toolbar">
          <span class="erd-label" id="erd-label" onclick="showOverviewERD()" style="cursor:pointer" title="Back to overview">Domain Overview</span>
          <button onclick="erdZoomOut()" title="Zoom out"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
          <button onclick="erdZoomIn()" title="Zoom in"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
          <button onclick="erdResetZoom()" title="Reset zoom"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
          <button onclick="erdFullscreen()" title="Fullscreen" id="erd-fs-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
        </div>
        <div class="erd-viewport" id="erd-viewport"></div>
      </div>
    </section>

    <div class="domain-grid" id="domain-grid"></div>
    <div id="domain-detail-container"></div>

    <div class="source-link">
      Source of truth: <a href="https://github.com/adar-schule/hinbuna-kurdi/blob/main/_docs/04-data-model-design.md">04-data-model-design.md</a>
      &middot; <a href="multi-lang.html">Multi-Language System</a>
    </div>
  </main>

  <div id="shared-footer"></div>
  <script src="shared/header.js"></script>
  <script src="shared/settings.js"></script>
  <script src="shared/footer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
  <script>
  (function(){
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      er: { useMaxWidth: false },
      themeVariables: isDark
        ? { primaryColor: '#2A363B', primaryBorderColor: '#D4A843', lineColor: '#4D9AAE', textColor: '#F5EEE6' }
        : { primaryColor: '#F5EEE6', primaryBorderColor: '#2D5A3D', lineColor: '#3B7A8A', textColor: '#1A2A1F' }
    });

    var erdViewport = document.getElementById('erd-viewport');
    var erdWrap = document.getElementById('erd-wrap');
    var erdLabel = document.getElementById('erd-label');
    var pzInstance = null, erdN = 0;

    var OVERVIEW = 'graph TD\n'
      + '  Content["Content (7)"] -->|progress| Progress["Progress (3)"]\n'
      + '  Content -->|translates| ML["Multi-Language (5)"]\n'
      + '  Users["Users & Auth (5)"] -->|teaches| Teacher["Teacher (4)"]\n'
      + '  Users -->|tracks| Progress\n'
      + '  Users -->|subscribes| Subs["Subscriptions (2)"]\n'
      + '  Users -->|skills| AI["AI Core (11)"]\n'
      + '  AI -->|premium| AIP["AI Premium (3)"]\n'
      + '  Users -->|earns| Badges["Badges (2)"]\n'
      + '  Users -->|posts| Comments["Comments (2)"]\n'
      + '  Users -->|receives| Notif["Notifications (2)"]\n'
      + '  Users -->|logs| Audit["Audit (1)"]\n'
      + '  Content -->|skills| AI';

    var ERDS = {
      'Content': 'erDiagram\n  courses ||--o{ modules : contains\n  modules ||--o{ units : contains\n  units ||--o{ lessons : contains\n  lessons ||--o{ activities : contains\n  activities ||--o{ activity_materials : has\n  materials ||--o{ activity_materials : "used in"',
      'Users & Auth': 'erDiagram\n  users ||--o{ user_roles : has\n  roles ||--o{ user_roles : "assigned as"\n  users ||--o{ invites : "invited by"\n  roles ||--o{ invites : "for role"',
      'Subscriptions': 'erDiagram\n  subscription_plans ||--o{ user_subscriptions : "plan for"\n  users ||--o{ user_subscriptions : subscribes',
      'Progress': 'erDiagram\n  users ||--o{ user_progress : tracks\n  users ||--o{ activity_attempts : submits\n  users ||--|| user_stats : has\n  activities ||--o{ activity_attempts : attempted',
      'Teacher': 'erDiagram\n  users ||--o{ classes : teaches\n  classes ||--o{ class_students : has\n  users ||--o{ class_students : "enrolled in"\n  classes ||--o{ assignments : has\n  users ||--o{ content_authors : authors',
      'Notifications': 'erDiagram\n  users ||--o{ notifications : receives\n  users ||--|| notification_preferences : has',
      'Badges': 'erDiagram\n  badges ||--o{ user_badges : "earned as"\n  users ||--o{ user_badges : earns',
      'Comments': 'erDiagram\n  users ||--o{ comments : posts\n  comments ||--o{ comment_reactions : has',
      'Audit': 'erDiagram\n  users ||--o{ audit_logs : "performed by"',
      'AI Core': 'erDiagram\n  skills ||--o{ user_skills : "proficiency in"\n  users ||--o{ user_skills : has\n  users ||--o{ user_errors : makes\n  activity_attempts ||--o{ user_errors : "error from"\n  users ||--|| user_learning_preferences : has\n  users ||--o{ user_events : generates\n  users ||--o{ session_logs : logs\n  users ||--|| user_behavior_profiles : has\n  users ||--|| user_engagement_scores : has\n  users ||--o{ ai_recommendations : receives\n  users ||--o{ spaced_repetition_items : reviews',
      'AI Premium': 'erDiagram\n  users ||--o{ ai_conversations : chats\n  user_characters ||--o{ ai_conversations : "character in"\n  users ||--o{ ai_generated_content : "generated for"\n  users ||--o{ user_characters : creates',
      'Multi-Language': 'erDiagram\n  courses ||--o{ course_translations : "translated as"\n  modules ||--o{ module_translations : "translated as"\n  units ||--o{ unit_translations : "translated as"\n  lessons ||--o{ lesson_translations : "translated as"'
    };

    function renderERD(code, label) {
      if (pzInstance) { pzInstance.dispose(); pzInstance = null; }
      while (erdViewport.firstChild) erdViewport.removeChild(erdViewport.firstChild);
      erdLabel.textContent = label;
      var pre = document.createElement('pre');
      pre.className = 'mermaid';
      pre.id = 'erd-n-' + (++erdN);
      pre.textContent = code;
      erdViewport.appendChild(pre);
      mermaid.run({ nodes: [pre] }).then(function(){
        var svg = erdViewport.querySelector('svg');
        if (!svg) return;
        svg.removeAttribute('width'); svg.removeAttribute('height');
        var vb = svg.getAttribute('viewBox');
        if (vb) {
          var p = vb.split(/[\s,]+/);
          var sw = parseFloat(p[2]), sh = parseFloat(p[3]);
          svg.style.width = sw + 'px'; svg.style.height = sh + 'px';
          var vpW = erdViewport.clientWidth, vpH = erdViewport.clientHeight;
          var fit = Math.min(vpW / sw, vpH / sh) * 0.88;
          var cx = (vpW - sw * fit) / 2, cy = (vpH - sh * fit) / 2;
          pzInstance = panzoom(svg, { maxZoom: 10, minZoom: 0.05, smoothScroll: false, initialX: cx, initialY: cy, initialZoom: fit });
        } else {
          pzInstance = panzoom(svg, { maxZoom: 10, minZoom: 0.05, smoothScroll: false });
        }
      });
    }

    window.showOverviewERD = function(){ renderERD(OVERVIEW, 'Domain Overview'); };
    window.showDomainERD = function(name){ if (ERDS[name]) renderERD(ERDS[name], name); };

    window.erdZoomIn = function(){
      if (!pzInstance) return;
      var t = pzInstance.getTransform(), r = erdViewport.getBoundingClientRect();
      pzInstance.smoothZoomAbs(r.width / 2, r.height / 2, t.scale * 1.4);
    };
    window.erdZoomOut = function(){
      if (!pzInstance) return;
      var t = pzInstance.getTransform(), r = erdViewport.getBoundingClientRect();
      pzInstance.smoothZoomAbs(r.width / 2, r.height / 2, t.scale / 1.4);
    };
    window.erdResetZoom = function(){
      if (!pzInstance) return;
      var svg = erdViewport.querySelector('svg'); if (!svg) return;
      var vb = svg.getAttribute('viewBox'); if (!vb) return;
      var p = vb.split(/[\s,]+/), sw = parseFloat(p[2]), sh = parseFloat(p[3]);
      var vpW = erdViewport.clientWidth, vpH = erdViewport.clientHeight;
      var fit = Math.min(vpW / sw, vpH / sh) * 0.88;
      var cx = (vpW - sw * fit) / 2, cy = (vpH - sh * fit) / 2;
      pzInstance.zoomAbs(0, 0, fit); pzInstance.moveTo(cx, cy);
    };
    window.erdFullscreen = function(){
      erdWrap.classList.toggle('fullscreen');
      var isFs = erdWrap.classList.contains('fullscreen');
      document.getElementById('erd-fs-btn').title = isFs ? 'Exit fullscreen' : 'Fullscreen';
      document.body.style.overflow = isFs ? 'hidden' : '';
      if (pzInstance) setTimeout(function(){ window.erdResetZoom(); }, 150);
    };

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && erdWrap.classList.contains('fullscreen')) window.erdFullscreen();
    });

    renderERD(OVERVIEW, 'Domain Overview');
  })();
  </script>

  <script>
  /* NOTE: innerHTML usage below is safe — all data comes from the hardcoded SCHEMA
     constant defined in this file, not from user input or external sources. */

  var SCHEMA = [
    {d:'Content',b:'core',t:'courses',desc:'Top-level learning courses',cols:[['id','UUID','PK'],['name','string',''],['description','text',''],['slug','string','unique'],['category','string','nullable — language, safety, math'],['metadata','JSON','domain-specific config'],['image_url','string','nullable'],['is_published','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['modules (1:N)','course_translations (1:N)']},
    {d:'Content',b:'core',t:'modules',desc:'Groups of units within a course',cols:[['id','UUID','PK'],['course_id','UUID','FK → courses'],['name','string',''],['description','text',''],['slug','string',''],['level','string','Beginner, A1, Week 1'],['order_index','int',''],['image_url','string','nullable'],['metadata','JSON',''],['is_published','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['courses (N:1)','units (1:N)','module_translations (1:N)']},
    {d:'Content',b:'core',t:'units',desc:'Thematic groups of lessons (access-gated)',cols:[['id','UUID','PK'],['module_id','UUID','FK → modules'],['name','string',''],['description','text',''],['slug','string',''],['order_index','int',''],['image_url','string','nullable'],['metadata','JSON',''],['is_free','boolean','ACCESS GATE'],['is_published','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['modules (N:1)','lessons (1:N)','unit_translations (1:N)']},
    {d:'Content',b:'core',t:'lessons',desc:'Individual learning sessions with activities',cols:[['id','UUID','PK'],['unit_id','UUID','FK → units'],['name','string',''],['description','text',''],['slug','string',''],['order_index','int',''],['duration_minutes','int','nullable — estimated'],['learning_objective','text','nullable'],['metadata','JSON',''],['is_published','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['units (N:1)','activities (1:N)','lesson_translations (1:N)']},
    {d:'Content',b:'core',t:'activities',desc:'Exercises: MCQ, gap fill, matching, flashcard, etc.',cols:[['id','UUID','PK'],['lesson_id','UUID','FK → lessons'],['type','enum','mcq, gap_fill, matching, flashcard, word_order, reading, listening'],['order_index','int',''],['content','JSON','Multi-lang JSONB (Pattern D)'],['metadata','JSON',''],['is_published','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['lessons (N:1)','activity_materials (1:N)','activity_skills (1:N)','activity_attempts (1:N)']},
    {d:'Content',b:'core',t:'materials',desc:'Reusable media: text, audio, image, video',cols:[['id','UUID','PK'],['type','enum','text, audio, image, video, document'],['content','text','text content OR S3 URL'],['metadata','JSON','translations, alt_text, duration'],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['activity_materials (1:N)']},
    {d:'Content',b:'core',t:'activity_materials',desc:'Join: activities ↔ materials',cols:[['activity_id','UUID','FK → activities, PK'],['material_id','UUID','FK → materials, PK'],['order_index','int','']],rels:['activities (N:1)','materials (N:1)']},

    {d:'Users & Auth',b:'core',t:'users',desc:'All user accounts (students, teachers, admins)',cols:[['id','UUID','PK'],['email','string','unique'],['password_hash','string',''],['first_name','string',''],['last_name','string',''],['display_name','string','nullable'],['avatar_url','string','nullable'],['language','string(5)','UI language — de, en, ku'],['ui_locale','string(10)','i18n UI labels'],['content_locale','string(10)','lesson translations'],['translations_visible','boolean','false = immersion mode'],['email_verified','boolean',''],['is_active','boolean','soft disable'],['metadata','JSON','preferences, profile extras'],['last_login_at','timestamp','nullable'],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['user_roles (1:N)','user_subscriptions (1:N)','user_progress (1:N)','classes (1:N as teacher)','notifications (1:N)']},
    {d:'Users & Auth',b:'core',t:'roles',desc:'Role definitions with permissions (B2B-ready)',cols:[['id','UUID','PK'],['name','string','Main Teacher, Content Reviewer'],['slug','string','unique — main_teacher, student'],['base_type','enum','student, teacher, admin'],['permissions','JSON','[manage_teachers, edit_content]'],['is_default','boolean','auto-assigned on register'],['is_system','boolean','true = cannot delete'],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['user_roles (1:N)','invites (1:N)']},
    {d:'Users & Auth',b:'core',t:'user_roles',desc:'Join: users ↔ roles (many-to-many)',cols:[['user_id','UUID','FK → users, PK'],['role_id','UUID','FK → roles, PK'],['assigned_by','UUID','FK → users, nullable'],['created_at','timestamp','']],rels:['users (N:1)','roles (N:1)']},
    {d:'Users & Auth',b:'core',t:'invites',desc:'Invite tokens for teacher/admin onboarding',cols:[['id','UUID','PK'],['email','string',''],['invited_by','UUID','FK → users'],['role_id','UUID','FK → roles'],['token','string','unique'],['used_at','timestamp','nullable'],['expires_at','timestamp',''],['created_at','timestamp','']],rels:['users (N:1)','roles (N:1)']},
    {d:'Users & Auth',b:'core',t:'app_settings',desc:'App-wide config: signup mode, locales, features',cols:[['id','UUID','PK (single row)'],['signup_mode','enum','public, invite_only, domain_restricted'],['allowed_domains','JSON','[@company.com]'],['subscriptions_enabled','boolean',''],['translations_enabled','boolean','disable for single-lang deploy'],['source_locale','string(10)','language being taught — ku'],['default_locale','string(10)','fallback for new users — de']],rels:[]},

    {d:'Subscriptions',b:'optional',t:'subscription_plans',desc:'Available plans: monthly, yearly, lifetime',cols:[['id','UUID','PK'],['name','string',''],['slug','string','unique'],['type','enum','recurring, one_time'],['interval','enum','month, year, null (lifetime)'],['price_cents','int','999 = 9.99'],['currency','string','EUR, USD'],['features','JSON','for display'],['is_active','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['user_subscriptions (1:N)']},
    {d:'Subscriptions',b:'optional',t:'user_subscriptions',desc:'User subscription status + payment info',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['plan_id','UUID','FK → subscription_plans'],['status','enum','active, cancelled, expired, paused'],['started_at','timestamp',''],['expires_at','timestamp','nullable (lifetime)'],['cancelled_at','timestamp','nullable'],['payment_provider','string','stripe, paypal, manual'],['payment_reference','string','external ID'],['metadata','JSON',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['users (N:1)','subscription_plans (N:1)']},

    {d:'Progress',b:'core',t:'user_progress',desc:'Completion status per content level',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['course_id','UUID','FK, nullable'],['module_id','UUID','FK, nullable'],['unit_id','UUID','FK, nullable'],['lesson_id','UUID','FK, nullable'],['status','enum','not_started, in_progress, completed'],['completed_at','timestamp','nullable'],['time_spent_seconds','int','nullable'],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['users (N:1)','courses (N:1)','modules (N:1)','units (N:1)','lessons (N:1)']},
    {d:'Progress',b:'core',t:'activity_attempts',desc:'Each attempt at an activity with score',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['activity_id','UUID','FK → activities'],['attempt_number','int','1, 2, 3...'],['answers','JSON','what user submitted'],['score','int','0-100'],['is_correct','boolean',''],['time_spent_seconds','int','nullable'],['completed_at','timestamp',''],['created_at','timestamp','']],rels:['users (N:1)','activities (N:1)','user_errors (1:N)']},
    {d:'Progress',b:'core',t:'user_stats',desc:'Denormalized stats: streaks, totals, last activity',cols:[['id','UUID','PK'],['user_id','UUID','FK, unique'],['total_lessons_completed','int',''],['total_activities_completed','int',''],['total_time_spent_seconds','int',''],['current_streak_days','int',''],['longest_streak_days','int',''],['last_activity_at','timestamp',''],['updated_at','timestamp','']],rels:['users (1:1)']},

    {d:'Teacher',b:'core',t:'classes',desc:'Teacher-created class groups',cols:[['id','UUID','PK'],['name','string',''],['description','text',''],['teacher_id','UUID','FK → users'],['course_id','UUID','FK, nullable'],['join_code','string','unique'],['is_active','boolean',''],['metadata','JSON',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['users (N:1 teacher)','class_students (1:N)','assignments (1:N)']},
    {d:'Teacher',b:'core',t:'class_students',desc:'Join: classes ↔ students',cols:[['class_id','UUID','FK, PK'],['student_id','UUID','FK → users, PK'],['joined_at','timestamp',''],['status','enum','active, removed'],['created_at','timestamp','']],rels:['classes (N:1)','users (N:1)']},
    {d:'Teacher',b:'core',t:'content_authors',desc:'Who owns/edits which content',cols:[['user_id','UUID','FK, PK'],['content_type','enum','course, module, unit, lesson, activity'],['content_id','UUID','PK'],['role','enum','owner, editor, viewer'],['created_at','timestamp','']],rels:['users (N:1)']},
    {d:'Teacher',b:'core',t:'assignments',desc:'Teacher assigns units/lessons to a class',cols:[['id','UUID','PK'],['class_id','UUID','FK → classes'],['assigned_by','UUID','FK → users'],['content_type','enum','unit, lesson'],['content_id','UUID',''],['due_date','timestamp','nullable'],['instructions','text','nullable'],['is_active','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['classes (N:1)','users (N:1)']},

    {d:'Notifications',b:'optional',t:'notifications',desc:'In-app + email notifications',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['type','enum','info, achievement, reminder, assignment, system'],['title','string',''],['message','text',''],['link','string','nullable — where to navigate'],['is_read','boolean',''],['read_at','timestamp','nullable'],['metadata','JSON',''],['created_at','timestamp','']],rels:['users (N:1)']},
    {d:'Notifications',b:'optional',t:'notification_preferences',desc:'Per-user notification settings',cols:[['id','UUID','PK'],['user_id','UUID','FK, unique'],['email_enabled','boolean',''],['email_frequency','enum','instant, daily, weekly, none'],['in_app_enabled','boolean',''],['types_enabled','JSON','[achievement, reminder]'],['updated_at','timestamp','']],rels:['users (1:1)']},

    {d:'Badges',b:'optional',t:'badges',desc:'Achievement definitions',cols:[['id','UUID','PK'],['name','string',''],['description','text',''],['icon_url','string',''],['category','enum','progress, streak, social, special'],['criteria','JSON','{type: lessons_completed, count: 1}'],['is_active','boolean',''],['created_at','timestamp','']],rels:['user_badges (1:N)']},
    {d:'Badges',b:'optional',t:'user_badges',desc:'Earned badges per user',cols:[['id','UUID','PK'],['user_id','UUID','FK'],['badge_id','UUID','FK'],['earned_at','timestamp',''],['metadata','JSON','context when earned']],rels:['users (N:1)','badges (N:1)']},

    {d:'Comments',b:'optional',t:'comments',desc:'Discussion on lessons/activities/units',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['parent_type','enum','lesson, activity, unit'],['parent_id','UUID',''],['parent_comment_id','UUID','FK → comments, nullable (replies)'],['content','text',''],['is_edited','boolean',''],['is_deleted','boolean','soft delete'],['metadata','JSON',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['users (N:1)','comments (self-ref)','comment_reactions (1:N)']},
    {d:'Comments',b:'optional',t:'comment_reactions',desc:'Likes, helpful, question on comments',cols:[['id','UUID','PK'],['comment_id','UUID','FK'],['user_id','UUID','FK'],['type','enum','like, helpful, question'],['created_at','timestamp','']],rels:['comments (N:1)','users (N:1)']},

    {d:'Audit',b:'optional',t:'audit_logs',desc:'Who did what when — CRUD + login/logout',cols:[['id','UUID','PK'],['user_id','UUID','FK, nullable (system)'],['action','enum','create, update, delete, login, logout'],['entity_type','string','course, lesson, user'],['entity_id','UUID',''],['changes','JSON','{field, old, new}'],['ip_address','string','nullable'],['user_agent','string','nullable'],['created_at','timestamp','']],rels:['users (N:1)']},

    {d:'AI Core',b:'core',t:'skills',desc:'Trackable competencies: vocab, grammar, listening...',cols:[['id','UUID','PK'],['name','string',''],['slug','string','unique'],['category','enum','vocabulary, grammar, listening, reading, speaking, writing'],['description','text','nullable'],['metadata','JSON',''],['is_active','boolean',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['activity_skills (1:N)','user_skills (1:N)']},
    {d:'AI Core',b:'core',t:'activity_skills',desc:'Join: activities ↔ skills (weighted)',cols:[['activity_id','UUID','FK → activities, PK'],['skill_id','UUID','FK → skills, PK'],['weight','decimal','0.0-1.0']],rels:['activities (N:1)','skills (N:1)']},
    {d:'AI Core',b:'core',t:'user_skills',desc:'User proficiency per skill (AI-calculated)',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['skill_id','UUID','FK → skills'],['proficiency','decimal','0.0-1.0'],['total_attempts','int',''],['correct_attempts','int',''],['last_practiced_at','timestamp','nullable'],['next_review_at','timestamp','nullable — SRS'],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['users (N:1)','skills (N:1)']},
    {d:'AI Core',b:'core',t:'user_errors',desc:'Specific mistakes for AI pattern analysis',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['activity_attempt_id','UUID','FK → activity_attempts'],['error_type','enum','vocabulary, grammar, spelling, listening, pronunciation'],['error_category','string','verb_conjugation, noun_gender...'],['source_item','string','word/phrase they got wrong'],['expected','string',''],['user_answer','string',''],['metadata','JSON','hints used, time, context'],['created_at','timestamp','']],rels:['users (N:1)','activity_attempts (N:1)']},
    {d:'AI Core',b:'core',t:'user_learning_preferences',desc:'How user prefers to learn + theme/accessibility',cols:[['id','UUID','PK'],['user_id','UUID','FK, unique'],['preferred_mode','enum','visual, audio, text, mixed'],['session_length','enum','short, medium, long'],['difficulty_preference','enum','easy, normal, challenging'],['daily_goal_minutes','int','nullable'],['review_frequency','enum','aggressive, normal, relaxed'],['theme_style','enum','zarok, ciwan, xort, mezin'],['font_size','enum','sm, md, lg, xl'],['contrast_mode','enum','normal, high'],['motion_preference','enum','full, reduced'],['color_mode','enum','light, dark, system'],['audio_cues','boolean','default true'],['metadata','JSON',''],['updated_at','timestamp','']],rels:['users (1:1)']},
    {d:'AI Core',b:'core',t:'user_events',desc:'Raw event stream: clicks, skips, retries, hints',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['event_type','enum','click, skip, pause, retry, hint_used, bookmark, complete, timeout'],['entity_type','string','lesson, activity, unit, page'],['entity_id','UUID','nullable'],['metadata','JSON','context, duration, position'],['created_at','timestamp','']],rels:['users (N:1)']},
    {d:'AI Core',b:'core',t:'session_logs',desc:'Login sessions: when, how long, what device',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['started_at','timestamp',''],['ended_at','timestamp','nullable'],['duration_seconds','int','computed'],['device_type','enum','mobile, tablet, desktop'],['browser','string','nullable'],['pages_visited','JSON','ordered list'],['metadata','JSON','']],rels:['users (N:1)']},
    {d:'AI Core',b:'core',t:'user_behavior_profiles',desc:'Computed learning habits (recalculated periodically)',cols:[['id','UUID','PK'],['user_id','UUID','FK, unique'],['preferred_time','string','nullable — morning, evening'],['avg_session_minutes','decimal',''],['avg_activities_per_session','decimal',''],['skip_rate','decimal','0.0-1.0'],['retry_rate','decimal','0.0-1.0'],['hint_usage_rate','decimal','0.0-1.0'],['speed_category','enum','slow, normal, fast'],['consistency_score','decimal','0.0-1.0'],['metadata','JSON',''],['updated_at','timestamp','']],rels:['users (1:1)']},
    {d:'AI Core',b:'core',t:'user_engagement_scores',desc:'Motivation signals: frustration, boredom, flow, dropout risk',cols:[['id','UUID','PK'],['user_id','UUID','FK, unique'],['engagement_level','enum','high, medium, low, at_risk'],['frustration_signals','int','rapid retries, rage-quits'],['boredom_signals','int','fast skips, low time-on-task'],['flow_signals','int','sustained focus periods'],['streak_current','int',''],['streak_longest','int',''],['dropout_risk','decimal','0.0-1.0 (AI-predicted)'],['last_calculated_at','timestamp',''],['metadata','JSON',''],['updated_at','timestamp','']],rels:['users (1:1)']},
    {d:'AI Core',b:'core',t:'ai_recommendations',desc:'AI suggestions: next lesson, review, practice, break',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['type','enum','next_lesson, review, practice_weak, challenge, break'],['entity_type','string','lesson, activity, unit, skill'],['entity_id','UUID','nullable'],['reason','text','e.g. You got 3/5 wrong on verb conjugation'],['priority','int','1=highest'],['is_acted_on','boolean','did user follow it?'],['metadata','JSON',''],['created_at','timestamp',''],['expires_at','timestamp','nullable']],rels:['users (N:1)']},
    {d:'AI Core',b:'core',t:'spaced_repetition_items',desc:'SM-2 review schedule per user per item',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['entity_type','enum','activity, skill, vocabulary_item'],['entity_id','UUID',''],['ease_factor','decimal','SM-2 (default 2.5)'],['interval_days','int',''],['repetitions','int','successful reviews'],['next_review_at','timestamp',''],['last_reviewed_at','timestamp',''],['metadata','JSON',''],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['users (N:1)']},

    {d:'AI Premium',b:'optional',t:'ai_conversations',desc:'Hevale AI chat logs — conversation practice',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['character_id','UUID','FK → user_characters, nullable'],['messages','JSON','[{role, content, timestamp}]'],['topic','string','nullable — greetings, shopping'],['skill_level','string','A1, A2, B1'],['corrections_made','int',''],['metadata','JSON',''],['started_at','timestamp',''],['ended_at','timestamp','nullable']],rels:['users (N:1)','user_characters (N:1)']},
    {d:'AI Premium',b:'optional',t:'ai_generated_content',desc:'Custom exercises/stories created by AI for user',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['type','enum','exercise, story, review_set, practice_dialogue'],['content','JSON','the generated content'],['based_on','JSON','{weak_skills, error_patterns}'],['quality_score','decimal','nullable — user feedback'],['metadata','JSON',''],['created_at','timestamp','']],rels:['users (N:1)']},
    {d:'AI Premium',b:'optional',t:'user_characters',desc:'User-created characters for story/conversation',cols:[['id','UUID','PK'],['user_id','UUID','FK → users'],['name','string',''],['avatar_config','JSON','appearance settings'],['personality','JSON','traits, interests'],['backstory','text','nullable'],['metadata','JSON',''],['is_active','boolean','default true'],['created_at','timestamp',''],['updated_at','timestamp','']],rels:['users (N:1)','ai_conversations (1:N)']},

    {d:'Multi-Language',b:'core',t:'supported_locales',desc:'Language registry for the deployment',cols:[['id','UUID','PK'],['locale','string(10)','unique — ku, de, en, sv'],['display_name','string(100)','Kurdî (Kurmancî), Deutsch'],['direction','string(3)','ltr or rtl'],['color','string(7)','nullable — for UI chips'],['is_source','boolean','true for ku (teaching lang)'],['is_default','boolean','fallback for new users'],['is_active','boolean',''],['order_index','int',''],['created_at','timestamp','']],rels:[]},
    {d:'Multi-Language',b:'core',t:'course_translations',desc:'Translated name/description per locale',cols:[['id','UUID','PK'],['course_id','UUID','FK → courses, CASCADE'],['locale','string(10)',''],['name','string(500)',''],['description','text','nullable'],['translation_source','enum','human, machine, machine_edited'],['source_locale','string(10)','nullable — translated from'],['translated_by','UUID','FK → users, nullable'],['reviewed_at','timestamp','nullable']],rels:['courses (N:1)']},
    {d:'Multi-Language',b:'core',t:'module_translations',desc:'Translated name/description per locale',cols:[['id','UUID','PK'],['module_id','UUID','FK → modules, CASCADE'],['locale','string(10)',''],['name','string(500)',''],['description','text','nullable'],['translation_source','enum','human, machine, machine_edited'],['source_locale','string(10)','nullable'],['translated_by','UUID','FK → users, nullable'],['reviewed_at','timestamp','nullable']],rels:['modules (N:1)']},
    {d:'Multi-Language',b:'core',t:'unit_translations',desc:'Translated name/description per locale',cols:[['id','UUID','PK'],['unit_id','UUID','FK → units, CASCADE'],['locale','string(10)',''],['name','string(500)',''],['description','text','nullable'],['translation_source','enum','human, machine, machine_edited'],['source_locale','string(10)','nullable'],['translated_by','UUID','FK → users, nullable'],['reviewed_at','timestamp','nullable']],rels:['units (N:1)']},
    {d:'Multi-Language',b:'core',t:'lesson_translations',desc:'Translated name/description/objective per locale',cols:[['id','UUID','PK'],['lesson_id','UUID','FK → lessons, CASCADE'],['locale','string(10)',''],['name','string(500)',''],['description','text','nullable'],['learning_objective','text','nullable'],['translation_source','enum','human, machine, machine_edited'],['source_locale','string(10)','nullable'],['translated_by','UUID','FK → users, nullable'],['reviewed_at','timestamp','nullable']],rels:['lessons (N:1)']},
  ];

  // ── Render ──
  var activeDomain = null, activeTable = null;
  var totalCols = SCHEMA.reduce(function(s,t){ return s + t.cols.length; }, 0);
  document.getElementById('total-columns').textContent = totalCols;

  var domainOrder = [], domainMap = {};
  SCHEMA.forEach(function(t){
    if (!domainMap[t.d]) { domainMap[t.d] = {name:t.d, badge:t.b, tables:[]}; domainOrder.push(t.d); }
    domainMap[t.d].tables.push(t);
  });

  var gridEl = document.getElementById('domain-grid');
  domainOrder.forEach(function(dName){
    var d = domainMap[dName];
    var card = document.createElement('div');
    card.className = 'domain-card';
    card.dataset.domain = dName;
    var nameSpan = document.createElement('span'); nameSpan.className = 'd-name'; nameSpan.textContent = dName;
    var badgeSpan = document.createElement('span'); badgeSpan.className = 'badge badge-' + d.badge; badgeSpan.textContent = d.badge;
    var countSpan = document.createElement('span'); countSpan.className = 'd-count'; countSpan.textContent = d.tables.length;
    var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('class','d-chevron'); svg.setAttribute('viewBox','0 0 24 24'); svg.setAttribute('fill','none'); svg.setAttribute('stroke','currentColor'); svg.setAttribute('stroke-width','2.5');
    var poly = document.createElementNS('http://www.w3.org/2000/svg','polyline'); poly.setAttribute('points','6 9 12 15 18 9'); svg.appendChild(poly);
    card.appendChild(nameSpan); card.appendChild(badgeSpan); card.appendChild(countSpan); card.appendChild(svg);
    card.addEventListener('click', function(){ toggleDomain(dName); });
    gridEl.appendChild(card);
  });

  function escHtml(s){ var d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

  function toggleDomain(dName){
    var container = document.getElementById('domain-detail-container');
    if (activeDomain === dName) { container.textContent=''; activeDomain=null; activeTable=null; document.querySelectorAll('.domain-card').forEach(function(c){c.classList.remove('active');}); if(window.showOverviewERD)showOverviewERD(); return; }
    activeDomain = dName; activeTable = null;
    document.querySelectorAll('.domain-card').forEach(function(c){ c.classList.toggle('active', c.dataset.domain===dName); });
    var d = domainMap[dName];
    var wrap = document.createElement('div'); wrap.className='domain-detail';
    var hdr = document.createElement('div'); hdr.className='domain-detail-header';
    var h2 = document.createElement('h2'); h2.textContent=dName; hdr.appendChild(h2);
    var hBadge = document.createElement('span'); hBadge.className='badge badge-'+d.badge; hBadge.textContent=d.badge; hdr.appendChild(hBadge);
    var hCount = document.createElement('span'); hCount.style.cssText='font-size:13px;color:var(--text-secondary)'; hCount.textContent=d.tables.length+' tables'; hdr.appendChild(hCount);
    wrap.appendChild(hdr);
    var list = document.createElement('div'); list.className='table-list';
    d.tables.forEach(function(t){
      var row = document.createElement('div'); row.className='table-row'; row.dataset.table=t.t;
      var tn=document.createElement('span'); tn.className='t-name'; tn.textContent=t.t;
      var td=document.createElement('span'); td.className='t-desc'; td.textContent=t.desc;
      var tc=document.createElement('span'); tc.className='t-cols'; tc.textContent=t.cols.length+' cols';
      var sv=document.createElementNS('http://www.w3.org/2000/svg','svg');
      sv.setAttribute('class','t-chevron'); sv.setAttribute('viewBox','0 0 24 24'); sv.setAttribute('fill','none'); sv.setAttribute('stroke','currentColor'); sv.setAttribute('stroke-width','2.5');
      var pl=document.createElementNS('http://www.w3.org/2000/svg','polyline'); pl.setAttribute('points','6 9 12 15 18 9'); sv.appendChild(pl);
      row.appendChild(tn); row.appendChild(td); row.appendChild(tc); row.appendChild(sv);
      row.addEventListener('click', function(e){ e.stopPropagation(); toggleTable(t.t); });
      list.appendChild(row);
      var sc=document.createElement('div'); sc.id='schema-'+t.t; list.appendChild(sc);
    });
    wrap.appendChild(list);
    container.textContent='';
    container.appendChild(wrap);
    if(window.showDomainERD)showDomainERD(dName);
    container.scrollIntoView({behavior:'smooth',block:'nearest'});
  }

  function toggleTable(tName){
    var el = document.getElementById('schema-'+tName);
    if (!el) return;
    if (activeTable===tName){ el.textContent=''; activeTable=null; document.querySelectorAll('.table-row').forEach(function(r){r.classList.remove('active');}); return; }
    if (activeTable){ var prev=document.getElementById('schema-'+activeTable); if(prev) prev.textContent=''; document.querySelectorAll('.table-row').forEach(function(r){r.classList.remove('active');}); }
    activeTable=tName;
    var t=SCHEMA.find(function(s){return s.t===tName;}); if(!t) return;
    document.querySelectorAll('.table-row[data-table="'+tName+'"]').forEach(function(r){r.classList.add('active');});
    var panel=document.createElement('div'); panel.className='schema-panel';
    var grid=document.createElement('div'); grid.className='schema-grid';
    t.cols.forEach(function(c){
      var cn=document.createElement('span'); cn.className='col-name'; cn.textContent=c[0];
      if(c[2].indexOf('PK')!==-1){ var b=document.createElement('span'); b.className='badge badge-pk'; b.textContent='PK'; cn.appendChild(document.createTextNode(' ')); cn.appendChild(b); }
      if(c[2].indexOf('FK')!==-1){ var b2=document.createElement('span'); b2.className='badge badge-fk'; b2.textContent='FK'; cn.appendChild(document.createTextNode(' ')); cn.appendChild(b2); }
      if(c[2].indexOf('unique')!==-1){ var b3=document.createElement('span'); b3.className='badge badge-uk'; b3.textContent='UK'; cn.appendChild(document.createTextNode(' ')); cn.appendChild(b3); }
      if(c[1]==='JSON'){ var b4=document.createElement('span'); b4.className='badge badge-json'; b4.textContent='JSON'; cn.appendChild(document.createTextNode(' ')); cn.appendChild(b4); }
      var ct=document.createElement('span'); ct.className='col-type'; ct.textContent=c[1];
      var cno=document.createElement('span'); cno.className='col-notes';
      var cleanNotes=c[2].replace(/PK,?\s*/g,'').replace(/FK[^,]*(,\s*)?/g,'').replace(/unique,?\s*/g,'').trim();
      cno.textContent=cleanNotes;
      grid.appendChild(cn); grid.appendChild(ct); grid.appendChild(cno);
    });
    panel.appendChild(grid);
    if(t.rels && t.rels.length>0){
      var rels=document.createElement('div'); rels.className='rels';
      var rt=document.createElement('div'); rt.className='rels-title'; rt.textContent='Relationships'; rels.appendChild(rt);
      t.rels.forEach(function(r){
        var ri=document.createElement('div'); ri.className='rel-item';
        var parts=r.match(/^(\w+)\s*\((.+)\)$/);
        if(parts){
          var code=document.createElement('code'); code.textContent=parts[1];
          ri.appendChild(code); ri.appendChild(document.createTextNode(' '+parts[2]));
          ri.addEventListener('click',function(){ jumpToTable(parts[1]); });
        } else { ri.textContent=r; }
        rels.appendChild(ri);
      });
      panel.appendChild(rels);
    }
    el.appendChild(panel);
  }

  function jumpToTable(tName){
    var t=SCHEMA.find(function(s){return s.t===tName;}); if(!t) return;
    if(activeDomain!==t.d) toggleDomain(t.d);
    setTimeout(function(){
      toggleTable(tName);
      var row=document.querySelector('.table-row[data-table="'+tName+'"]');
      if(row) row.scrollIntoView({behavior:'smooth',block:'center'});
    },100);
  }
  </script>
</body>
</html>
